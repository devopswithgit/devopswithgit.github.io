<!DOCTYPE html>
<html>
    <head>
        <title>Accman : Development Notes</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Accman</a></span>
                            </li>
                                                    <li>
                                <span><a href="Accman-Home_16384043.html">Accman Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="RFC-and-Project-Work_16384025.html">RFC and Project Work</a></span>
                            </li>
                                                    <li>
                                <span><a href="Email-for-Life_16384064.html">Email for Life</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Accman : Development Notes
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Unknown User (uis894)</span> on Jul 02, 2012
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <div class="WordSection1"><h1 id="DevelopmentNotes-E-mailforLife">E-mail for Life</h1><h2 id="DevelopmentNotes-ProposedWorkPlan">Proposed Work Plan</h2><h3 id="DevelopmentNotes-Notes">Notes</h3><p>All file locations in this document are specified relative to the root accMan directory.</p><h3 id="DevelopmentNotes-RequirementSW383-13">Requirement SW383-13</h3><p>This requirement demands that it should be possible to differentiate between a student and an alumnus. It is proposed that this is achieved by adding an additional column to the person table in the accMan database. The specification of this column is:</p><div align="center"><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"><p><strong>Column Name</strong></p></td><td class="confluenceTd"><p><strong>Data Type</strong></p></td><td class="confluenceTd"><p><strong>Permissible Values</strong></p></td></tr><tr><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p> </p></td></tr><tr><td class="confluenceTd"><p>is_alumnus</p></td><td class="confluenceTd"><p>tinyint</p></td><td class="confluenceTd"><p>NULL, 0 (false) or 1 (true)</p></td></tr></tbody></table></div><p> </p></div><p> </p><p>The above column will need to be initially set to NULL for all existing person records; since there is currently no definitive source to identify an alumnus in accMan, it will not be possible to back-fill this field without further analysis.</p><p>For the purposes of this requirement, an alumnus is regarded as a student with a non-NULL value in the BANNER field SKBHINS_ENDDATE. The latter is currently imported via the BANNER interface script scripts\banner4import.pl into the accMan table banner_import.</p><p>Once data is loaded into banner_import from BANNER, it is processed and used to populate the accMan table person by the script scripts\banner4person, which calls the sub-routine updateStudentPerson in the script lib\studentPerson.pl. The latter script (i.e. lib\studentPerson.pl) contains two SQL statements that will need to be modified, both of which are declared in the sub-routine prepareStudentPersonSQL:</p><p>$insh -           INSERT statement to populate person record</p><p>$updh -           UPDATE statement to update existing person record</p><p>Both of these statements will need to be amended to set the is_alumnus field in person to 1 if SKBHINS_ENDDATE is populated, or 0 otherwise.</p><h4 id="DevelopmentNotes-Summary">Summary</h4><p>A new field, is_alumnus, is added to the person table and the script lib\studentPerson.pl is amended to populate this field, based on the content of SKBHINS_ENDDATE in banner_import.</p><h3 id="DevelopmentNotes-RequirementSW838-01">Requirement SW838-01</h3><p>In order to prevent accMan from disabling a student’s e-mail account on graduation, the following change is proposed.</p><h4 id="DevelopmentNotes-Changestolib\disableAccount.pl">Changes to lib\disableAccount.pl</h4><p>When a student graduates, their account is disabled directly by the script lib\disableAccount.pl. The current version of this script disables the Microsoft Live e-mail account by creating a type 62 transaction. Note that this script is called by scripts\scheduled\SISImport\studentautostate.pl (see below), which determines <em>if</em> an account should be disabled.</p><p>The proposed amendment to lib\disableAccount.pl is that disabling of the Microsoft Live e-mail account becomes optional, and is controlled by an additional input parameter.</p><p>Current, lib\disableAccount.pl expects the following input parameters:</p><p>$dbh                                       - Database connection handle (required)</p><p>$accID                                   - Account to be disabled (required)</p><p>$reason                                - Reason account is to be disabled (required)</p><p>$cure                                     - Circumstance in which account to be re-enabled (optional)</p><p>It is proposed that an additional, mandatory parameter is added:</p><p>$disable_edu_account   - Should Microsoft Live e-mail be disabled (required)</p><p>Since Perl does not recognise an explicit Boolean datatype, $disable_edu_account should be set to 0 (false) or 1 (true).</p><p>In order to maintain $cure as an optional parameter, $disable_edu_account should be added between $accID and $reason.</p><p>The creation of the type 62 transaction – which is currently labelled #APB in the source code of lib\disableAccount.pl - should now be wrapped in an if… statement that will only create the transaction if $disable_edu_account is true.</p><h4 id="DevelopmentNotes-ChangestoAccountManagementScript">Changes to Account Management Script</h4><p>The single script scripts\scheduled\SISImport\studentautostate.pl directly accesses lib\disableAccount.pl as part of its job of disabling the accounts of students who have left the University.</p><p>There are two sections of  scripts\scheduled\SISImport\studentautostate.pl that will require amendment to support this change; the first is the sub-routine prepareSQL, which is where the database queries against the accMan database are defined. The second is the sub-routine disable, which selects the actual student records to process before passing the details of each to lib\disableAccount.pl in turn.</p><p>The sub-routine disable executes the query defined by the variable $seldish. This is defined in prepareSQL and the query text is assigned to the local variable $seldis. The latter will need to be modified to read the column is_alumnus, as created by requirement SW383-13 (see above).</p><p><strong><em>This section is not complete.</em></strong></p><h4 id="DevelopmentNotes-ChangestoOtherImpactedScripts">Changes to Other Impacted Scripts</h4><p>lib\disableAccount.pl is accessed by a series of other scripts that are not directly concerned with handling the disabling of a graduating student’s account. These will need to be amended to cater for the additional, mandatory parameter expected by lib\disableAccount.pl.</p><p>The scripts affected are:</p><p>scripts\register.pl</p><p>scripts\scheduled\deduplicateWeekly.pl</p><p>scripts\scheduled\staffautostate.pl</p><p>scripts\scheduled\staffmultileft.pl</p><p>scripts\scheduled\staffsequential.pl</p><p>scripts\assign.pl</p><p>scripts\extend.pl</p><p>Each of the above scripts directly calls lib\disableAccount.pl and will need amending to incorporate the new parameter $disable_edu_account. The default value of 1 (i.e. true) should be used in all cases, as this will mimic the current behaviour of disabling the student’s Microsoft Live e-mail account.</p><p>As an example, the following statement (from scripts\assign.pl):</p><p>my $trID = disableAccount ($dbh, $otherAccID, $reason);</p><p>would become:</p><p>my $trID = disableAccount ($dbh, $otherAccID, true, $reason);</p><p> </p><p> </p><p align="center"><strong><u>Changes made so far by Andy Jones</u></strong></p><p> </p><p><strong><u>/lib/disableAccount.pl</u></strong></p><p>my ($dbh, $accID, $disable_edu_account, $reason, $cure) = @_;                          DONE</p><p> </p><p><strong><u>/scripts/assign.pl</u></strong></p><p>      my $trID = disableAccount ($dbh, $otherAccID, <span style="text-decoration: line-through;">true</span> 1, $reason);                      DONE</p><p> </p><p><strong><u>/scripts/extend.pl </u></strong></p><p>$new_trID = disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, $reason);                                  DONE</p><p> </p><p><strong><u>/scripts/register.pl </u></strong></p><p>  disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, $disabledReason) or return 0;                    DONE</p><p> </p><p><strong><u>scripts/scheduled/SISImport/studentautostate.pl</u></strong></p><p>      $trID = disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, &quot;Now using $user2&quot;);                  DONE</p><p>$trID = disableAccount ($dbh, $accID, $disable_edu_account, $reason{$person_state}, $cure{$stu_ests});</p><p> </p><p><strong><u>scripts\scheduled\deduplicateWeekly.pl</u></strong></p><p>    my $trID = disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, 'Student has left');                   DONE</p><p>    my $trID = disableAccount ($dbh, $otherAccID, <span style="text-decoration: line-through;">true</span> 1, $reason);                        DONE</p><p> </p><p><strong><u>scripts\scheduled\staffautostate.pl</u></strong></p><p>      $trID = disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, &quot;Now using $user2&quot;);                  DONE</p><p>    $trID = disableAccount ($dbh, $accID, <span style="text-decoration: line-through;">true</span> 1, $reason);                                       DONE</p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>scripts\scheduled\staffmultileft.pl</u></strong></p><p>    disableAccount2 ($accID_2, $username,<span style="text-decoration: line-through;"> true</span> 1);                                      DONE</p><p>        disableAccount2 ($accID_2, $username, <span style="text-decoration: line-through;">true</span> 1);                                  DONE</p><p>      disableAccount2 ($accID_2, $username, <span style="text-decoration: line-through;">true</span> 1);                                    DONE</p><p> </p><p>  my ($accID, $username, $disable_edu_email) = @_;</p><p>  my $trID = disableAccount ($dbh, $accID, $disable_edu_email, $reason);</p><p> </p><p><strong><u>scripts\scheduled\staffsequential.pl</u></strong></p><p>    disableAccount2 ($accID_2, $username, <span style="text-decoration: line-through;">true</span> 1);                                      DONE</p><p>        disableAccount2 ($accID_2, $username, <span style="text-decoration: line-through;">true</span> 1);                                  DONE</p><p>      disableAccount2 ($accID_2, $username, <span style="text-decoration: line-through;">true</span> 1);                                    DONE</p><p>  my ($accID, $username, $disable_edu_email) = @_;</p><p>  my $trID = disableAccount ($dbh, $accID, $disable_edu_email, $reason);</p><p> </p><p>I also changed . . . .</p><p><strong>lib\StudentPerson.pl</strong></p><p> </p><p> </p><p> </p><p>Things to do . . . .</p><ul><li>search for “disableAccount” and “disableAccount2” references on the production server in order to confirm the above is correct.</li></ul><p> </p><ul><li>also, what is “disableAccount2” ????<ul><li>Function <strong>disableAccount2</strong> in script <strong>script\scheduled\staffmultileft.pl</strong> has been changed to include $disable_edu_email parameter</li><li>Function <strong>disableAccount2</strong> in script <strong>script\scheduled\staffsequential.pl</strong> has been changed to include $disable_edu_email parameter</li></ul></li></ul><p> </p><ul><li>Have a look at the revised requirements document to make sure we haven’t missed anything.</li></ul><p> </p><p> </p><p>Searching for: disableAccount</p><p>lib\disableAccount.pl(3): # disableAccount.pl - disable account</p><p>lib\disableAccount.pl(5): # $trID = disableAccount ($dbh, $accID, $reason, $cure)</p><p>lib\disableAccount.pl(27): sub disableAccount {</p><p>lib\disableAccount.pl(77): print &quot;disableAccount.pl - about to generate type 62 tx\n&quot;;</p><p>lib\disableAccount.pl(86): print &quot;disableAccount.pl - edu_trID=$edu_trID\n&quot;;</p><p>scripts\assign.pl(29): require 'disableAccount.pl';</p><p>scripts\assign.pl(333): my $trID = disableAccount ($dbh, $otherAccID, $reason);</p><p>scripts\extend.pl(12): require 'disableAccount.pl';</p><p>scripts\extend.pl(61): $new_trID = disableAccount ($dbh, $accID, $reason);</p><p>scripts\moverename.pl(278): disableAccount ($fquser) or return 0;</p><p>scripts\moverename.pl(283): disableAccount ($fqolduser) or return 0;</p><p>scripts\moverename.pl(549): sub disableAccount {</p><p>scripts\register.beforeallan.pl(101): require 'disableAccount.pl';</p><p>scripts\register.beforeallan.pl(481): disableAccount ($dbh, $accID, $disabledReason) or return 0;</p><p>scripts\register.pl(118): require 'disableAccount.pl';</p><p>scripts\register.pl(569): disableAccount ($dbh, $accID, $disabledReason) or return 0;</p><p>scripts\LiveEduProcessors\ChangePassword\change_password_processor.pl(22): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\LiveEduProcessors\CreateUsers\create_users_processor.pl(21): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\LiveEduProcessors\DisableUsers\disable_users_processor - Copy.pl(22): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\LiveEduProcessors\DisableUsers\disable_users_processor NEW.pl(22): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\LiveEduProcessors\DisableUsers\disable_users_processor.pl(22): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\LiveEduProcessors\EnableUsers\enable_users_processor.pl(22): #             E.g for a type 62 &quot;LiveEduDisableAccount&quot; transaction, the parameters are:</p><p>scripts\scheduled\deduplicateWeekly.pl(18): ### for debugging, remove following and uncomment sub disableAccount ###</p><p>scripts\scheduled\deduplicateWeekly.pl(19): require 'disableAccount.pl';</p><p>scripts\scheduled\deduplicateWeekly.pl(43): my $trID = disableAccount ($dbh, $accID, 'Student has left');</p><p>scripts\scheduled\deduplicateWeekly.pl(54): my $trID = disableAccount ($dbh, $otherAccID, $reason);</p><p>scripts\scheduled\deduplicateWeekly.pl(61): ## sub disableAccount {</p><p>scripts\scheduled\staffautostate.pl(9): # 2004-11-18 ARG 2 Use library disableAccount and enableAccount.</p><p>scripts\scheduled\staffautostate.pl(17): require 'disableAccount.pl';</p><p>scripts\scheduled\staffautostate.pl(70): $trID = disableAccount ($dbh, $accID, &quot;Now using $user2&quot;);</p><p>scripts\scheduled\staffautostate.pl(91): $trID = disableAccount ($dbh, $accID, $reason);</p><p>scripts\scheduled\staffmultileft.pl(24): require 'disableAccount.pl';</p><p>scripts\scheduled\staffmultileft.pl(117): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(153): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(177): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(216): sub disableAccount2 {</p><p>scripts\scheduled\staffmultileft.pl(219): my $trID = disableAccount ($dbh, $accID, $reason);</p><p>scripts\scheduled\staffsequential.pl(25): require 'disableAccount.pl';</p><p>scripts\scheduled\staffsequential.pl(121): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(156): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(180): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(219): sub disableAccount2 {</p><p>scripts\scheduled\staffsequential.pl(222): my $trID = disableAccount ($dbh, $accID, $reason);</p><p>scripts\scheduled\SISImport\studentautostate.pl(12): # 2004-11-17 ARG 5 Use library connect, disableAccount, enableAccount. Update $session.</p><p>scripts\scheduled\SISImport\studentautostate.pl(30): require 'disableAccount.pl';</p><p>scripts\scheduled\SISImport\studentautostate.pl(137): $trID = disableAccount ($dbh, $accID, &quot;Now using $user2&quot;);</p><p>scripts\scheduled\SISImport\studentautostate.pl(164): $trID = disableAccount ($dbh, $accID, $reason{$person_state}, $cure{$stu_ests});</p><p>scripts\scheduled\SISImport\studentautostate_PREV_20110901.pl(12): # 2004-11-17 ARG 5 Use library connect, disableAccount, enableAccount. Update $session.</p><p>scripts\scheduled\SISImport\studentautostate_PREV_20110901.pl(30): require 'disableAccount.pl';</p><p>scripts\scheduled\SISImport\studentautostate_PREV_20110901.pl(136): $trID = disableAccount ($dbh, $accID, &quot;Now using $user2&quot;);</p><p>scripts\scheduled\SISImport\studentautostate_PREV_20110901.pl(163): $trID = disableAccount ($dbh, $accID, $reason{$person_state}, $cure{$stu_ests});</p><p>Found 51 occurrence(s) in 18 file(s)</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>Searching for: disableAccount2</p><p>scripts\scheduled\staffmultileft.pl(117): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(153): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(177): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffmultileft.pl(216): sub disableAccount2 {</p><p>scripts\scheduled\staffsequential.pl(121): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(156): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(180): disableAccount2 ($accID_2, $username);</p><p>scripts\scheduled\staffsequential.pl(219): sub disableAccount2 {</p><p>Found 8 occurrence(s) in 2 file(s)</p><p> </p><p> </p></div><p align="center"><strong><u>DETAILED CHANGES TO BE MADE</u></strong></p><p> </p><p> </p><p> </p><ol><li><strong>1.    </strong><strong><u>Add “is_alumnus” column to person table</u></strong></li></ol><p> </p><p><code>alter table</code><code> mail.person add column is_alumnus tinyint default null;</code></p><p> </p><p>To drop the column:</p><p> </p><p><code>alter table</code><code> mail.person drop column is_alumnus;</code></p><p> </p><ol><li><strong>2.    </strong><strong><u>Add transaction type descriptions to trtypes table</u></strong></li></ol><p> </p><p><strong>INSERT INTO mail.trtypes (tr_type_id, tr_description, tr_disabled, tr_running) VALUES (122, 'Hide In Email Address Lists', 'N', 'N');#</strong></p><p><strong> </strong></p><p><strong>INSERT INTO mail.trtypes (tr_type_id, tr_description, tr_disabled, tr_running) VALUES (124, 'Unhide In Email Address Lists', 'N', 'N');</strong></p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><ol><li><strong>3.    </strong><strong><u>Changes to lib\studentPerson.pl script (Requirement SW838-13)</u></strong></li></ol><p> </p><p>Changes required to the following sub routines:</p><p> </p><p><strong>sub prepareStudentPersonSQL { }</strong></p><p> </p><p><strong>sub updateStudentPerson { }</strong></p><p> </p><p> </p><p><strong>NB:  The following was used to evaluate $end_date</strong></p><p><strong> </strong></p><p><a href="http://www.perlmonks.org/?node_id=598879" class="external-link" rel="nofollow">http://www.perlmonks.org/?node_id=598879</a></p><p> </p><p>Perl tries to make things as easy as possible for you and this is a good example.</p><p>In most cases, what you actually want is as simple as:</p><p>if ($value) {</p><p>  # $value contains something useful</p><p>} else {</p><p>  # $value is &quot;empty&quot;</p><p>}</p><p><a href="http://www.perlmonks.org/?abspart=1;displaytype=displaycode;node_id=598956;part=1" class="external-link" rel="nofollow">[download]</a></p><p>(Note that the logic is reversed from your original example)</p><p>What we're doing here is checking the &quot;truth&quot; of $value. $value will be &quot;false&quot; if it contains any of the following values:</p><ul><li>&quot;undef&quot; (i.e. if it hasn't been given a value)</li><li>The number 0</li><li>The string &quot;0&quot;</li><li>The empty string (&quot;&quot;)</li></ul><p>Any other value in $value will evaluate to &quot;true&quot;.</p><p>This is all you need in most cases. There are a couple of &quot;corner cases&quot; that you sometimes have to consider:</p><ul><li>Sometimes 0 is an acceptable value. You account for that by using if ($value or $value == 0).</li><li>Sonetimes you might want to test that $value contains nothing but whitespace characters. The easiest way to do that is by checking for the presence of non-whitespace characters with if ($value =~ /\S/).</li></ul><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong>#!perl</strong></p><p><strong> </strong></p><p><strong>#</strong></p><p><strong>## studentPerson.pl</strong></p><p><strong>#</strong></p><p><strong># utility routines for parsing values from SPRIDEN, SPBPERS, SGBSTDN and SFBETRM and assigning them to values for person</strong></p><p><strong># and updating the person table with the student data</strong></p><p><strong>#</strong></p><p><strong>#</strong></p><p><strong># 2005-06-28 ARG 1 initial version</strong></p><p><strong># 2005-09-09 ARG 2 always import 'expected', otherwise check new and existing acad_sess and person_state before deciding whether to import</strong></p><p><strong># 2005-09-18 ARG 3 add table-driven title parsing (incident 1388)</strong></p><p><strong># 2005-10-04 ARG 4 ignore dots in source title</strong></p><p><strong># 2005-10-06 ARG 5 always overwrite an expected with a present in this session (incident 1460)</strong></p><p><strong># 2005-04-20 ARG 6 rationalise import logic, add $force to updateStudentPerson, add $current_sess (NB will need to update every summer)</strong></p><p><strong># 2005-04-26 ARG 7 use midYearProg.PROGRAM and prog.UOMS for determining potential leavers - CR1912</strong></p><p><strong># 2005-09-01 ARG 8 new PGR degc codes - incident 2153; update $current_sess</strong></p><p><strong># 2006-09-20 ARG 9 new value for SGBSTDN_STYP_CODE - incident 2238</strong></p><p><strong># 2006-09-26 ARG 10 add SPBPERS_BIRTH_DATE and b_date code - CR 2091, correct start_date and end_date logic - incident 2154</strong></p><p><strong># 2007-06-20 ARG 11 add logic for 'graduating' person_state -  RFC 0053</strong></p><p><strong># 2007-08-09 ARG 12 rollover to 2008 current_sess, lastGrad, nextGrad</strong></p><p><strong># 2007-09-24 ARG 13 new value for SGBSTDN_STYP_CODE - incident 2238</strong></p><p><strong># 2007-10-08 ARG 14 RX can be present if on MSc or PGDip (applies to foreign colleges) - case 3768</strong></p><p><strong># 2008-05-20 ARG 15 use SKBHINS_ENDDATE instead of SKBSLVE_DATELEFT; don't import 'left' when existing record is in future; remove obsolete qual_aim_code logic</strong></p><p><strong># 2008-06-10 ARG 16 automate current_sess</strong></p><p><strong># 2008-06-12 ARG 17 program change will trigger leaver flag update, in addition to block change</strong></p><p><strong># 2008-11-05 ARG 18 2008/09 lastGrad, nextGrad</strong></p><p><strong># 2009-07-09 ARG 19 don't import 'expected' for following year if 'present' for db year on same programme and yr_course &gt; db_yr_course</strong></p><p><strong># 2009-08-06 20 ARG automation of Graduation dates (up to 2012, guess 2013, backstop 2020)</strong></p><p><strong># 2011-08-25 AJJ 21 added update janus user details transaction on update person record</strong></p><p><strong># 2012-04-11 AJJ 22 added update ad details transaction on update person record</strong></p><p><strong> </strong></p><p><strong>use warnings;</strong></p><p><strong>use strict;</strong></p><p><strong>use DBI;</strong></p><p><strong> </strong></p><p><strong>use lib ('lib', '../lib', '../../lib');</strong></p><p><strong>require 'connect.pl';</strong></p><p><strong>require 'generateTransaction.pl';</strong></p><p><strong> </strong></p><p><strong>my $current_sess = sessionnow();</strong></p><p><strong> </strong></p><p><strong># graduationDate is last Friday of Graduation Ceremonies (see University Almanac)</strong></p><p><strong># slightly more efficient to remove old ones (except latest)</strong></p><p><strong># my @graduationDate = ('2007-07-20', '2008-07-18', '2009-07-17', '2010-07-16', '2011-07-15', '2012-07-13', '2013-07-19', '2020-12-31');</strong></p><p><strong>my @graduationDate = ('2009-07-17', '2010-07-16', '2011-07-15', '2012-07-13', '2013-07-19', '2020-12-31');</strong></p><p><strong> </strong></p><p><strong>my %titlemap;</strong></p><p><strong>my %pstate;</strong></p><p><strong>my %depthash;</strong></p><p><strong>my %SYdepthash;</strong></p><p><strong> </strong></p><p><strong>my %psc = (</strong></p><p><strong>  UG =&gt; 'U',</strong></p><p><strong>  PG =&gt; 'P',</strong></p><p><strong>  FE =&gt; 'N',</strong></p><p><strong>  PQ =&gt; 'U',</strong></p><p><strong>  CE =&gt; 'N',</strong></p><p><strong>);</strong></p><p><strong> </strong></p><p><strong>my %pgr = (</strong></p><p><strong>  DMA =&gt; 'Y',</strong></p><p><strong>  DPROF =&gt; 'Y',</strong></p><p><strong>  MPHIL =&gt; 'Y',</strong></p><p><strong>  MRES =&gt; 'Y',</strong></p><p><strong>  MSR =&gt; 'Y',</strong></p><p><strong>  PHD =&gt; 'Y',</strong></p><p><strong>  DBENV =&gt; 'Y',</strong></p><p><strong>  DREAL =&gt; 'Y',</strong></p><p><strong>  DCONM =&gt; 'Y',</strong></p><p><strong>);</strong></p><p><strong> </strong></p><p><strong>my ($selh, $insh, $addh, $updh, $exth, $leaveh, $logh, $sth, $rejh);</strong></p><p><strong>my ($change);</strong></p><p><strong>my $studentPersonSQLprepared = undef;</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub initialiseParsing {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # MUST be called once before any of the parseXxxx subs</strong></p><p><strong>  getTitleHash ($dbh);</strong></p><p><strong>  getPstateHash ($dbh);</strong></p><p><strong>  getDeptHash ($dbh);</strong></p><p><strong>  getSYdeptHash ($dbh);</strong></p><p><strong>  finishDB ($dbh, $sth);</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub finishStudentPersonSQL {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # MUST be called before closing database</strong></p><p><strong>  finishDB ($dbh, $selh, $insh, $addh, $updh, $exth, $leaveh, $logh, $sth, $rejh);</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub parsePerson {</strong></p><p><strong>  my ($SPRIDEN_PIDM, $SPRIDEN_ID, $SPRIDEN_LAST_NAME, $SPRIDEN_FIRST_NAME, $SPRIDEN_MI, $SPBPERS_BIRTH_DATE, $SPBPERS_SEX, $SPBPERS_NAME_PREFIX, $rejref) = @_;</strong></p><p><strong>  # Given the input above, returns the list below. Note $rejref is a hash ref and would be called as \%reject.</strong></p><p><strong>  my ($pidm, $rollnumber, $realname, $initials, $forenames, $preferredName, $title, $b_date);</strong></p><p><strong> </strong></p><p><strong>  #get PIDM (no need to check)</strong></p><p><strong>  $pidm = $SPRIDEN_PIDM;</strong></p><p><strong> </strong></p><p><strong>  # validate the SPRIDEN_ID and generate the rollnumber</strong></p><p><strong>  if ($SPRIDEN_ID =~ m/^@\d{8}$/) {</strong></p><p><strong>    $rollnumber = $SPRIDEN_ID;</strong></p><p><strong>    $rollnumber =~ s/^@//;     # Remove leading @ sign</strong></p><p><strong>  } elsif ($SPRIDEN_ID eq '@0007225') {</strong></p><p><strong>    $rollnumber = 7225;  # Special case the student with a valid 7-digit SPRIDEN_ID '@0007225'</strong></p><p><strong>  } else {</strong></p><p><strong>    $rejref -&gt; {'SPRIDEN_ID'} = $SPRIDEN_ID;</strong></p><p><strong>    $rollnumber = 0;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # check surname</strong></p><p><strong>  $realname = $SPRIDEN_LAST_NAME || '';</strong></p><p><strong>  $realname =~ s/\./ /g;    # replace all dots by spaces</strong></p><p><strong>  $realname =~ s/^ +//;     # remove extra spaces at start</strong></p><p><strong>  $realname =~ s/ +$//;     # remove extra spaces at end</strong></p><p><strong>  $realname =~ s/  / /g;    # remove extra spaces in middle</strong></p><p><strong>  # translate accented characters - this will work under Windows (probably only if Banner UI</strong></p><p><strong>  # and this script are both Windows apps. CMD console shows DOS charset, but is a Windows app!)</strong></p><p><strong>  $realname =~ tr (ŠŽšžŸÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ)</strong></p><p><strong>                  (SZszYAAAAAACEEEEIIIIDNOOOOOOUUUUYYaaaaaaaceeeeiiiidnoooooouuuuyyy);</strong></p><p><strong>  $rejref -&gt; {'SPRIDEN_LAST_NAME'} = $SPRIDEN_LAST_NAME unless $realname =~ m/^[A-Z][-\s'A-Z]*$/i;</strong></p><p><strong> </strong></p><p><strong>  # check first name</strong></p><p><strong>  my $firstName = $SPRIDEN_FIRST_NAME || '';</strong></p><p><strong>  $firstName =~ s/\./ /g;    # replace all dots by spaces</strong></p><p><strong>  $firstName =~ s/^ +//;     # remove extra spaces at start</strong></p><p><strong>  $firstName =~ s/ +$//;     # remove extra spaces at end</strong></p><p><strong>  $firstName =~ s/  / /g;    # remove extra spaces in middle</strong></p><p><strong>  # translate accented characters - this will work under Windows (probably only if Banner UI</strong></p><p><strong>  # and this script are both Windows apps. CMD console shows DOS charset, but is a Windows app!)</strong></p><p><strong>  $firstName =~ tr (ŠŽšžŸÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ)</strong></p><p><strong>                   (SZszYAAAAAACEEEEIIIIDNOOOOOOUUUUYYaaaaaaaceeeeiiiidnoooooouuuuyyy);</strong></p><p><strong>  $rejref -&gt; {'SPRIDEN_FIRST_NAME'} = $SPRIDEN_FIRST_NAME unless $firstName =~ m/^[A-Z][-\s'A-Z]*$/i;</strong></p><p><strong> </strong></p><p><strong>  # check middle name(s)</strong></p><p><strong>  my $middleName = $SPRIDEN_MI || '';</strong></p><p><strong>  $middleName =~ s/\./ /g;    # replace all dots by spaces</strong></p><p><strong>  $middleName =~ s/^ +//;     # remove extra spaces at start</strong></p><p><strong>  $middleName =~ s/ +$//;     # remove extra spaces at end</strong></p><p><strong>  $middleName =~ s/  / /g;    # remove extra spaces in middle</strong></p><p><strong>  # translate accented characters - this will work under Windows (probably only if Banner UI</strong></p><p><strong>  # and this script are both Windows apps. CMD console shows DOS charset, but is a Windows app!)</strong></p><p><strong>  $middleName =~ tr (ŠŽšžŸÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ)</strong></p><p><strong>                    (SZszYAAAAAACEEEEIIIIDNOOOOOOUUUUYYaaaaaaaceeeeiiiidnoooooouuuuyyy);</strong></p><p><strong>  $rejref -&gt; {'SPRIDEN_MI'} = $SPRIDEN_MI unless $middleName =~ m/^(?:[A-Z][-\s'A-Z]*)?$/i;</strong></p><p><strong> </strong></p><p><strong>  # set preferredName</strong></p><p><strong>  $preferredName = $SPRIDEN_FIRST_NAME;</strong></p><p><strong> </strong></p><p><strong>  # set forenames</strong></p><p><strong>  $forenames = $middleName ? &quot;$firstName $middleName&quot; : $firstName;</strong></p><p><strong> </strong></p><p><strong>  # extract initials from the forenames</strong></p><p><strong>  $initials = $forenames;</strong></p><p><strong>  $initials =~ s/'//g;            # remove apostrophes</strong></p><p><strong>  $initials =~ s/(\w)\w*\W*/$1/g; # get initials</strong></p><p><strong>  $initials =~ tr/[a-z]/[A-Z]/;   # uppercase</strong></p><p><strong> </strong></p><p><strong>  # translate source title to AccMan title</strong></p><p><strong>  if (defined $SPBPERS_NAME_PREFIX) {</strong></p><p><strong>    my $undotted = $SPBPERS_NAME_PREFIX;</strong></p><p><strong>    $undotted =~ s/\.//g;         # remove dots</strong></p><p><strong>    $title = $titlemap {$undotted};</strong></p><p><strong>  } else {</strong></p><p><strong>    undef $title;</strong></p><p><strong>  }</strong></p><p><strong>  unless (defined $title) {</strong></p><p><strong>    $title = '';</strong></p><p><strong>    $rejref -&gt; {'SPBPERS_NAME_PREFIX'} = $SPBPERS_NAME_PREFIX;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # copy date of birth</strong></p><p><strong>  $b_date = $SPBPERS_BIRTH_DATE;</strong></p><p><strong>  if (defined $b_date) {</strong></p><p><strong>    $b_date =~ s/ .*//;</strong></p><p><strong>  } else {</strong></p><p><strong>    $rejref -&gt; {'SPBPERS_BIRTH_DATE'} = $SPBPERS_BIRTH_DATE;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  return ($pidm, $rollnumber, $realname, $initials, $forenames, $preferredName, $title, $b_date);</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub parseCourse {</strong></p><p><strong>  my ($SGBSTDN_TERM_CODE_EFF, $SGBSTDN_STST_CODE, $SGBSTDN_LEVL_CODE, $SGBSTDN_STYP_CODE, $SGBSTDN_DEGC_CODE_1, $SGBSTDN_MAJR_CODE_1, $SGBSTDN_BLCK_CODE, $SGBSTDN_DEPT_CODE, $SGBSTDN_PROGRAM_1, $rejref) = @_;</strong></p><p><strong>  # Given the input above, returns the list below. Note $rejref is a hash ref and would be called as \%reject.</strong></p><p><strong>  my ($acad_sess, $person_status_code, $stu_term, $stu_stst, $stu_levl, $sos_code, $program, $stu_att, $dept_code, $stu_styp, $stu_degc, $qual_aim_code, $stu_block, $yr_course, $yr_student, $leaver_flag);</strong></p><p><strong> </strong></p><p><strong>  # get student status and calculate person_state</strong></p><p><strong>  $stu_stst = $SGBSTDN_STST_CODE;</strong></p><p><strong>  $rejref -&gt; {'SGBSTDN_STST_CODE'} = $SGBSTDN_STST_CODE unless $stu_stst =~ m/AS|IS|DE|IG|RR|SU|WD|WU|IN|WN/;</strong></p><p><strong> </strong></p><p><strong>  # check stu_levl and generate person_status_code</strong></p><p><strong>  $stu_levl = $SGBSTDN_LEVL_CODE;</strong></p><p><strong>  my $newpsc = $psc {$SGBSTDN_LEVL_CODE};</strong></p><p><strong>  if (defined $newpsc) {</strong></p><p><strong>    $person_status_code = $newpsc;</strong></p><p><strong>  } else {</strong></p><p><strong>    $person_status_code = 'U';</strong></p><p><strong>    $rejref -&gt; {'SGBSTDN_LEVL_CODE'} = $SGBSTDN_LEVL_CODE;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # get stu_term</strong></p><p><strong>  $stu_term = $SGBSTDN_TERM_CODE_EFF;</strong></p><p><strong> </strong></p><p><strong>  # generate and check acad_sess</strong></p><p><strong>  # only reject some values if there's a valid term code - this will have been set to zero if the SGBSTDN record is missing for a pre-registered student</strong></p><p><strong>  $acad_sess = substr ($SGBSTDN_TERM_CODE_EFF, 0, 4);</strong></p><p><strong>  $rejref -&gt; {'SGBSTDN_TERM_CODE_EFF'} = $SGBSTDN_TERM_CODE_EFF if $acad_sess and ($acad_sess &lt; 2000 or $acad_sess &gt; 2020);</strong></p><p><strong> </strong></p><p><strong>  # get sos_code - actually MAJOR - this is totally obsolete</strong></p><p><strong>  $sos_code = $SGBSTDN_MAJR_CODE_1;</strong></p><p><strong> </strong></p><p><strong>  # check program - normally AB/BCD/F (except MBA/F and similar)</strong></p><p><strong>  # and extract attendance code</strong></p><p><strong>  $program = $SGBSTDN_PROGRAM_1 || 'X/X/X';</strong></p><p><strong>  if ($program =~ m{/([^/]\w*$)}) {</strong></p><p><strong>    $stu_att = $1;</strong></p><p><strong>    $rejref -&gt; {'SGBSTDN_PROGRAM_1'} = $SGBSTDN_PROGRAM_1 unless $stu_att =~ m/^([FSPEDLO]|LI)$/ and $acad_sess;</strong></p><p><strong>  } else {</strong></p><p><strong>    $stu_att = 'F';</strong></p><p><strong>    $rejref -&gt; {'SGBSTDN_PROGRAM_1'} = $SGBSTDN_PROGRAM_1 unless $acad_sess;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # translate SIS dept_code to valid AccMan dept_code and check</strong></p><p><strong>  my $newdept = $depthash {$SGBSTDN_DEPT_CODE} if defined $SGBSTDN_DEPT_CODE;</strong></p><p><strong>  if (defined $newdept) {</strong></p><p><strong>    $dept_code = $newdept;</strong></p><p><strong>  } else {</strong></p><p><strong>    $dept_code = $SGBSTDN_DEPT_CODE || 'ZZ';</strong></p><p><strong>    $rejref -&gt; {'SGBSTDN_DEPT_CODE'} = $SGBSTDN_DEPT_CODE;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # translate obsolete SY codes to EL for Chemistry courses, otherwise SG</strong></p><p><strong>  if ($dept_code eq 'SY') {</strong></p><p><strong>    my $SYdept = $SYdepthash {$SGBSTDN_PROGRAM_1} if defined $SGBSTDN_PROGRAM_1;</strong></p><p><strong>    $dept_code = $SYdept || 'SG';</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # check stu_styp</strong></p><p><strong>  $stu_styp = $SGBSTDN_STYP_CODE;</strong></p><p><strong>  $rejref -&gt; {'SGBSTDN_STYP_CODE'} = $SGBSTDN_STYP_CODE unless $SGBSTDN_STYP_CODE =~ m/[FNCDET]/ and $acad_sess;</strong></p><p><strong> </strong></p><p><strong>  # get stu_degc - accept anything</strong></p><p><strong>  $stu_degc = $SGBSTDN_DEGC_CODE_1;</strong></p><p><strong> </strong></p><p><strong>  # generate qual_aim_code - remove if PGR/PGT coding can be improved</strong></p><p><strong>  if ($person_status_code eq 'P') {</strong></p><p><strong>    $qual_aim_code = defined $pgr {$stu_degc} ? 2 : 5;</strong></p><p><strong>  } elsif ($person_status_code eq 'U') {</strong></p><p><strong>    $qual_aim_code = 21;</strong></p><p><strong>  } else {</strong></p><p><strong>    $qual_aim_code = 76;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # check stu_block and yr_course</strong></p><p><strong>  if (defined $SGBSTDN_BLCK_CODE) {</strong></p><p><strong>    $stu_block = $SGBSTDN_BLCK_CODE;</strong></p><p><strong>    $yr_course = substr ($SGBSTDN_BLCK_CODE, -1); # last character of BLOCK</strong></p><p><strong>  } else {</strong></p><p><strong>    $stu_block = '';</strong></p><p><strong>    $yr_course = 0;</strong></p><p><strong>  }</strong></p><p><strong>  unless ($yr_course =~ m/[1-9]/) {</strong></p><p><strong>    $yr_course = 0;</strong></p><p><strong>    $rejref -&gt; {'SGBSTDN_BLCK_CODE'} = $SGBSTDN_BLCK_CODE unless $acad_sess;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # check yr_student - obsolete</strong></p><p><strong>  $yr_student = ($stu_styp =~ m/[FC]/ ? 2 : 1);</strong></p><p><strong> </strong></p><p><strong>  # check leaver_flag</strong></p><p><strong>  $leaver_flag = '';</strong></p><p><strong> </strong></p><p><strong>  return ($acad_sess, $person_status_code, $stu_term, $stu_stst, $stu_levl, $sos_code, $program, $stu_att, $dept_code, $stu_styp, $stu_degc, $qual_aim_code, $stu_block, $yr_course, $yr_student, $leaver_flag);</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub parseRegistration {</strong></p><p><strong>  my ($pidm, $acad_sess, $program, $SFBETRM_AR_IND, $SFBETRM_ADD_DATE, $SFBETRM_ESTS_CODE, $SKBHINS_ENDDATE, $rejref) = @_;</strong></p><p><strong>  # Given the input above, returns the list below. Note $rejref is a hash ref and would be called as \%reject.</strong></p><p><strong>  my ($person_state, $stu_ests, $reg_status, $start_date, $end_date);</strong></p><p><strong> </strong></p><p><strong>  # get and check the reg_status</strong></p><p><strong>  $reg_status = $SFBETRM_AR_IND;</strong></p><p><strong>  $rejref -&gt; {'SFBETRM_AR_IND'} = $SFBETRM_AR_IND unless $reg_status =~ m/^[YCN]$/;</strong></p><p><strong> </strong></p><p><strong>  # get enrollment status and calculate person_state</strong></p><p><strong>  $stu_ests = $SFBETRM_ESTS_CODE;</strong></p><p><strong>  my $newpstate = $pstate {$SFBETRM_ESTS_CODE};</strong></p><p><strong>  if (defined $newpstate) {</strong></p><p><strong>    $person_state = $newpstate;</strong></p><p><strong>  } else {</strong></p><p><strong>    $rejref -&gt; {'SFBETRM_ESTS_CODE'} = $SFBETRM_ESTS_CODE;</strong></p><p><strong>    $person_state = 'absent';</strong></p><p><strong>  }</strong></p><p><strong>  # hack to allow Riga, Toulon and Crete MBA/MSc/PGDip students access (all other RX courses are FD at present)</strong></p><p><strong>  if ($person_state eq 'absent' and $stu_ests eq 'RX' and $program =~ m/^M|^PD/) {</strong></p><p><strong>    $person_state = 'present';</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  my $today = datenow ();</strong></p><p><strong> </strong></p><p><strong>  # get start_date</strong></p><p><strong>  $start_date = $SFBETRM_ADD_DATE;</strong></p><p><strong>  if (defined $start_date and $start_date ne '0000-00-00') {</strong></p><p><strong>    $start_date =~ s/ .*//;</strong></p><p><strong>  } else {</strong></p><p><strong>    $start_date = $today;</strong></p><p><strong>    $rejref -&gt; {'SFBETRM_ADD_DATE'} = $SFBETRM_ADD_DATE;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  # If there is a leaving date for the student and program, and it's in the correct academic session, the student has left</strong></p><p><strong>  # NB the leaving date for the correct program is guaranteed from the import selection</strong></p><p><strong>  # if the student is actually flagged as left, we don't need to check that the leaving date is in this session</strong></p><p><strong>  if (defined $SKBHINS_ENDDATE) {</strong></p><p><strong>    # the only way a graduate is detected is by the leaving date: their ESTS code remains RE (or equiv)</strong></p><p><strong>    # treat rollover date as 1 Aug; allow for students registered in other months by extending period to end of following acad session;</strong></p><p><strong>    # if they subsequently come back they'll get a new later term record</strong></p><p><strong>    # allow rolled over WN students to have a leaving date in the previous session (some may not actually have a leaving date)</strong></p><p><strong>    my ($earliest, $start, $end, $rollover, $left_date);</strong></p><p><strong>    $rollover = '-08-01';</strong></p><p><strong>    $earliest = $acad_sess - 5 . $rollover;</strong></p><p><strong>    $start = $acad_sess - ($stu_ests =~ m/WN/ ? 2 : 1) . $rollover;</strong></p><p><strong>    $end = $acad_sess + 1 . $rollover;</strong></p><p><strong>    $end = $today if $end gt $today;</strong></p><p><strong>    $left_date = $SKBHINS_ENDDATE;</strong></p><p><strong>    $left_date =~ s/ .*//;</strong></p><p><strong>    if ($left_date lt $earliest or $left_date gt $end) {</strong></p><p><strong>      $rejref -&gt; {'SKBHINS_ENDDATE'} = $SKBHINS_ENDDATE;</strong></p><p><strong>    } else {</strong></p><p><strong>      my ($grad_start, $grad_end);</strong></p><p><strong>      foreach my $date (@graduationDate) {</strong></p><p><strong>        $grad_end = $date;</strong></p><p><strong>        last if $today le $grad_end;</strong></p><p><strong>        $grad_start = $grad_end;</strong></p><p><strong>      }</strong></p><p><strong>      if (($person_state eq 'present' or $stu_ests =~ m/IG|RW|TG/) and $left_date gt $grad_start and $left_date le $grad_end) {</strong></p><p><strong>        $end_date = $left_date;</strong></p><p><strong>        $person_state = 'graduating';</strong></p><p><strong>      } elsif ($left_date ge $start and $left_date le $end) {</strong></p><p><strong>        $end_date = $left_date;</strong></p><p><strong>        $person_state = 'left';</strong></p><p><strong>      }</strong></p><p><strong>    }</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  return ($person_state, $stu_ests, $reg_status, $start_date, $end_date);</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub getTitleHash {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # set up titlemap hash to determine person.title from input title</strong></p><p><strong>  %titlemap = ();</strong></p><p><strong>  $sth = $dbh -&gt; prepare ('select title, source_title from titleMap') or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute;</strong></p><p><strong>  while (my ($title, $source_title) = $sth -&gt; fetchrow_array) {</strong></p><p><strong>    $titlemap {$source_title} = $title;</strong></p><p><strong>  }</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub getPstateHash {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # set up pstate hash to determine default person_state from stu_ests code</strong></p><p><strong>  %pstate = ();</strong></p><p><strong>  $sth = $dbh -&gt; prepare ('select stu_ests, person_state from student_ests') or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute;</strong></p><p><strong>  while (my ($ests, $person_state) = $sth -&gt; fetchrow_array) {</strong></p><p><strong>    $pstate {$ests} = $person_state;</strong></p><p><strong>  }</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub getDeptHash {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # set up department hash to map Banner dept codes to current AccMan codes</strong></p><p><strong>  %depthash = ();</strong></p><p><strong>  $sth = $dbh -&gt; prepare ('select SGBSTDN_DEPT_CODE, dept_code from banner_dept') or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute;</strong></p><p><strong>  while (my ($srdept, $aisdept) = $sth -&gt; fetchrow_array) {</strong></p><p><strong>    $depthash {$srdept} = $aisdept;</strong></p><p><strong>  }</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub getSYdeptHash {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  # set up SY department hash to map school for obsolete SY Banner dept chemistry programme codes to EL rather than SG</strong></p><p><strong>  %SYdepthash = ();</strong></p><p><strong>  $sth = $dbh -&gt; prepare ('select program from SY_to_EL_program_codes') or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute;</strong></p><p><strong>  while (my ($program) = $sth -&gt; fetchrow_array) {</strong></p><p><strong>    $SYdepthash {$program} = 'EL';</strong></p><p><strong>  }</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub updateStudentPerson {</strong></p><p><strong>  my ($dbh, $importID, $pidm, $SPRIDEN_ID, $rollnumber, $realname, $initials, $forenames, $preferredName, $title, $acad_sess, $person_status_code, $stu_term, $stu_stst, $stu_levl, $sos_code, $program, $stu_att, $dept_code, $stu_styp, $stu_degc, $qual_aim_code, $stu_block, $yr_course, $yr_student, $leaver_flag, $person_state, $stu_ests, $reg_status, $start_date, $end_date, $b_date, $force) = @_;</strong></p><p><strong>  # update or insert student data into person (based on rollnumber, not PIDM - historical); return personID</strong></p><p><strong>  my $personID;</strong></p><p><strong> </strong></p><p><strong>  # if SKBHINS_ENDDATE ($end_date) is populated then the student is an alumnus, so set person.is_alumnus = 1</strong></p><p><strong>  my $is_alumnus = 0;</strong></p><p><strong> </strong></p><p><strong>  if ($end_date) {</strong></p><p><strong>      print &quot;studentPerson.pl – student $SPRIDEN_ID is an alumnus.\n&quot;;</strong></p><p><strong>      $is_alumnus = 1;</strong></p><p><strong>  }</strong></p><p><strong>  else {</strong></p><p><strong>      print &quot;studentPerson.pl – student $SPRIDEN_ID is not an alumnus.\n&quot;;</strong></p><p><strong>      $is_alumnus = 0;</strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  prepareStudentPersonSQL ($dbh) unless $studentPersonSQLprepared;</strong></p><p><strong> </strong></p><p><strong>  # (Try to) get matching record from person table</strong></p><p><strong>  $selh -&gt; execute ($rollnumber);</strong></p><p><strong> </strong></p><p><strong>  unless (my ($db_personID, $db_initials, $db_realname, $db_sos_code, $db_person_status_code, $db_dept_code, $db_forenames, $db_qual_aim_code, $db_person_state, $db_importID, $db_yr_student, $db_yr_course, $db_acad_sess, $db_reg_status, $db_leaver_flag, $db_pidm, $db_title, $db_program, $db_stu_term, $db_stu_levl, $db_stu_styp, $db_stu_degc, $db_stu_block, $db_stu_stst, $db_stu_ests, $db_stu_att, $db_start_date, $db_end_date, $db_preferredName, $db_b_date) = $selh -&gt; fetchrow_array) {</strong></p><p><strong> </strong></p><p><strong>    # no existing record found with given rollnumber - add one and log it</strong></p><p><strong> </strong></p><p><strong>    # calculate final-year status</strong></p><p><strong>    $leaver_flag = set_leaver ($program, $yr_course);</strong></p><p><strong> </strong></p><p><strong>    $insh -&gt; execute ($initials, $realname, $rollnumber, $SPRIDEN_ID, $sos_code, $person_status_code, $dept_code, $forenames, $qual_aim_code, $person_state, $importID, $importID, $yr_student, $yr_course, $acad_sess, $reg_status, $leaver_flag, $pidm, $title, $program, $stu_term, $stu_levl, $stu_styp, $stu_degc, $stu_block, $stu_stst, $stu_ests, $stu_att, $start_date, $end_date, $preferredName, $b_date, $is_alumnus);</strong></p><p><strong> </strong></p><p><strong>    $personID = $insh -&gt; {mysql_insertid} or die $insh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>    $addh -&gt; execute ($importID, $rollnumber);</strong></p><p><strong> </strong></p><p><strong>  } else {</strong></p><p><strong> </strong></p><p><strong>    # person record already exists for this student - see if we should update it</strong></p><p><strong> </strong></p><p><strong>    $personID = $db_personID;</strong></p><p><strong> </strong></p><p><strong>    if ($force) {</strong></p><p><strong> </strong></p><p><strong>      # always update the record if forced (used for no-shows)</strong></p><p><strong> </strong></p><p><strong>    } elsif ($person_state eq 'expected') {</strong></p><p><strong> </strong></p><p><strong>      # don't import 'expected' for following year if 'present' for db year on same programme and yr_course &gt; db_yr_course</strong></p><p><strong>      return $personID if ($db_person_state eq 'present' and $program eq $db_program and $acad_sess &gt; $db_acad_sess and $yr_course &gt; $db_yr_course);</strong></p><p><strong> </strong></p><p><strong>      # otherwise always update the record if 'expected'</strong></p><p><strong> </strong></p><p><strong>    } elsif ($acad_sess &gt; $db_acad_sess) {</strong></p><p><strong> </strong></p><p><strong>      # update the record if this record is for a more recent session</strong></p><p><strong> </strong></p><p><strong>    } else {</strong></p><p><strong> </strong></p><p><strong>      # don't import if existing record contains future data and new data would be worse</strong></p><p><strong>      return $personID if ($db_acad_sess &gt; $current_sess and $person_state ne 'left');</strong></p><p><strong> </strong></p><p><strong>      # don't import if new data is older than existing data</strong></p><p><strong>      return $personID if $acad_sess &lt; $db_acad_sess;</strong></p><p><strong> </strong></p><p><strong>      # new data is for same session as existing one</strong></p><p><strong> </strong></p><p><strong>      # if term_code is the same, import the new data</strong></p><p><strong>      unless ($stu_term eq $db_stu_term) {</strong></p><p><strong>        # two courses in this session</strong></p><p><strong> </strong></p><p><strong>        # previous one was present, but this one isn't - ignore</strong></p><p><strong>        return $personID if $db_person_state eq 'present' and $person_state ne 'present';</strong></p><p><strong> </strong></p><p><strong>        # both records are present, or both are not present, so we have to choose</strong></p><p><strong>        # sort by qual_aim code (in general, smallest no is highest qual):</strong></p><p><strong>        # <a href="http://www.hesa.ac.uk/Manuals" class="external-link" rel="nofollow">http://www.hesa.ac.uk/Manuals</a> and look for QUALAIM</strong></p><p><strong>        # PG 02-14, 62, 98</strong></p><p><strong>        # HE 19-52, 61, 97</strong></p><p><strong>        # FE 53-55, 71-83, 99</strong></p><p><strong>        # codes 15, 16, 48, 49, 100 are not used, so use them for temp transformation to classify some old codes in descending order</strong></p><p><strong>        # (but this is now obsolete)</strong></p><p><strong>        # my $qtemp = $db_qual_aim_code || 100;</strong></p><p><strong>        # if ($qtemp == 61) {$qtemp = 48}</strong></p><p><strong>        # elsif ($qtemp == 97) {$qtemp = 49}</strong></p><p><strong>        # elsif ($qtemp == 62) {$qtemp = 15}</strong></p><p><strong>        # elsif ($qtemp == 98) {$qtemp = 16}</strong></p><p><strong>        # currently qual_aim_code will only be PGR: 02, PGT; 05, UG: 21, (FE: 76 also now obsolete)</strong></p><p><strong>        # return $personID if $qtemp &lt; $qual_aim_code;</strong></p><p><strong> </strong></p><p><strong>        # if existing qual_aim_code is lower, we ignore the new data</strong></p><p><strong>        return $personID if $db_qual_aim_code &lt; $qual_aim_code;</strong></p><p><strong>      }</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    # if we reach here, we're updating the record</strong></p><p><strong> </strong></p><p><strong>    # do we already know that the student has left?</strong></p><p><strong>    # if the student isn't here, preserve an 'extended' or 'deleted' state (set outside the import process)</strong></p><p><strong>    my $alreadyleft = $person_state =~ m/^left|^absent/ &amp;&amp; ($db_person_state eq $person_state || $db_person_state =~ m/^extended|^deleted/);</strong></p><p><strong>    $person_state = $db_person_state if $alreadyleft;</strong></p><p><strong> </strong></p><p><strong>    # if necessary, set the final-year status</strong></p><p><strong>    my $block_change = (not defined $db_stu_block or $db_stu_block ne $stu_block or $db_program ne $program);</strong></p><p><strong>    $leaver_flag = set_leaver ($program, $yr_course) if $block_change or not defined $db_leaver_flag or $db_leaver_flag !~ m/[YN]/;</strong></p><p><strong>    $leaver_flag = $db_leaver_flag if $leaver_flag !~ m/[YN]/;</strong></p><p><strong> </strong></p><p><strong>    # log the changes</strong></p><p><strong> </strong></p><p><strong>    $change = 0;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'initials', $db_initials, $initials) if $db_initials ne $initials;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'realname', $db_realname, $realname) if $db_realname ne $realname;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'sos_code', $db_sos_code, ,$sos_code) if $db_sos_code ne $sos_code;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'person_status_code', $db_person_status_code, $person_status_code) if $db_person_status_code ne $person_status_code;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'dept_code', $db_dept_code, $dept_code) if $db_dept_code ne $dept_code;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'qual_aim_code', $db_qual_aim_code, $qual_aim_code) if $db_qual_aim_code != $qual_aim_code;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'forenames', $db_forenames, $forenames) if not defined $db_forenames or $db_forenames ne $forenames;</strong></p><p><strong> </strong></p><p><strong>    # only overwrite preferredName if it isn't there already or if forenames and preferredName have changed</strong></p><p><strong>    # - allows for manually setting preferredName in AccMan independently of Banner</strong></p><p><strong>    if (not defined $db_preferredName or ($db_forenames ne $forenames and $db_preferredName ne $preferredName)) {</strong></p><p><strong>      logchange ($importID, $personID, 'preferredName', $db_preferredName, $preferredName);</strong></p><p><strong>    } else {</strong></p><p><strong>      $preferredName = $db_preferredName;</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'acad_sess', $db_acad_sess, $acad_sess) if $db_acad_sess != $acad_sess;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'yr_course', $db_yr_course, $yr_course) if not defined $db_yr_course or $db_yr_course != $yr_course;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'yr_student', $db_yr_student, $yr_student) if not defined $db_yr_student or $db_yr_student != $yr_student;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'reg_status', $db_reg_status, $reg_status) if not defined $db_reg_status or $db_reg_status ne $reg_status;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'person_state', $db_person_state, $person_state) if $db_person_state ne $person_state;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'pidm', $db_pidm, $pidm) if not defined $db_pidm or $db_pidm ne $pidm;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'title', $db_title, $title) if not defined $db_title or ($db_title ne $title and $db_title ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'program', $db_program, $program) if not defined $db_program or $db_program ne $program;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_levl', $db_stu_levl, $stu_levl) if not defined $db_stu_levl or ($db_stu_levl ne $stu_levl and $db_stu_levl ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_styp', $db_stu_styp, $stu_styp) if not defined $db_stu_styp or ($db_stu_styp ne $stu_styp and $db_stu_styp ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_degc', $db_stu_degc, $stu_degc) if not defined $db_stu_degc or $db_stu_degc ne $stu_degc;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_block', $db_stu_block, $stu_block) if $block_change;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'leaver_flag', $db_leaver_flag, $leaver_flag) if not defined $db_leaver_flag or $db_leaver_flag ne $leaver_flag;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_stst', $db_stu_stst, $stu_stst) if not defined $db_stu_stst or ($db_stu_stst ne $stu_stst and $db_stu_stst ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_ests', $db_stu_ests, $stu_ests) if not defined $db_stu_ests or ($db_stu_ests ne $stu_ests and $db_stu_ests ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'stu_att', $db_stu_att, $stu_att) if not defined $db_stu_att or ($db_stu_att ne $stu_att and $db_stu_att ne '');</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'start_date', $db_start_date, $start_date) if not defined $db_start_date or $db_start_date ne $start_date;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'end_date', $db_end_date, $end_date) if not defined $db_end_date and defined $end_date or defined $db_end_date and not defined $end_date or defined $db_end_date and defined $end_date and $db_end_date ne $end_date;</strong></p><p><strong> </strong></p><p><strong>    logchange ($importID, $personID, 'b_date', $db_b_date, $b_date) if not defined $db_b_date and defined $b_date or defined $db_b_date and not defined $b_date or defined $db_b_date and defined $b_date and $db_b_date ne $b_date;</strong></p><p><strong> </strong></p><p><strong>    # now update the database</strong></p><p><strong> </strong></p><p><strong>    # but don't bother if we know the user has already left and nothing else has changed</strong></p><p><strong>    # this will give us an idea of when the student actually left</strong></p><p><strong>    # but we do need to keep track of 'extended' students</strong></p><p><strong>    return $personID if $alreadyleft and $person_state ne 'extended' and not $change;</strong></p><p><strong> </strong></p><p><strong>    # check for pre-extended newly left or absent student</strong></p><p><strong>    if ($person_state =~ m/left|absent/ and not $alreadyleft) {</strong></p><p><strong>      $exth -&gt; execute ($personID);</strong></p><p><strong>      $person_state = 'extended' if $exth -&gt; fetchrow_array;</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    $updh -&gt; execute ($importID, $initials, $realname, $SPRIDEN_ID, $sos_code, $person_status_code, $dept_code, $forenames, $qual_aim_code, $person_state, $yr_student, $yr_course, $acad_sess, $reg_status, $leaver_flag, $pidm, $title, $program, $stu_term, $stu_levl, $stu_styp, $stu_degc, $stu_block, $stu_stst, $stu_ests, $stu_att, $start_date, $end_date, $preferredName, $b_date, $is_alumnus, $personID);</strong></p><p><strong>      if ($change) {</strong></p><p><strong>      # create janus update transaction</strong></p><p><strong>      my %transactionParams = (</strong></p><p><strong>        'ROLLNUMBER' =&gt; $rollnumber,</strong></p><p><strong>        'SOURCE' =&gt; 'studentPerson.pl',</strong></p><p><strong>      );</strong></p><p><strong>        my $childTrID;</strong></p><p><strong>        return 0 unless $childTrID = generateTransaction ($dbh, 97, $personID, %transactionParams);</strong></p><p><strong>        return 0 unless $childTrID = generateTransaction ($dbh, 121, $personID, %transactionParams);</strong></p><p><strong>      }</strong></p><p><strong>  }</strong></p><p><strong>  return $personID;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub set_leaver {</strong></p><p><strong>  my ($program, $yr_course) = @_;</strong></p><p><strong>  # returns leaver_flag</strong></p><p><strong>  # to avoid an excessive join in Banner for every student, only set the leaver_flag if:</strong></p><p><strong>  # 1) it's a new student record or</strong></p><p><strong>  # 2) the student's block has changed or</strong></p><p><strong>  # 3) we don't have a valid leaver code in person table</strong></p><p><strong>  # Potential bug - if the length of an existing program is changed we never know</strong></p><p><strong> </strong></p><p><strong>  # if we don't know the year, the student can't be a leaver</strong></p><p><strong>  return 'N' unless $yr_course;</strong></p><p><strong>  $leaveh -&gt; execute ($program);</strong></p><p><strong>  my ($length, $uoms, $nonleaver) = $leaveh -&gt; fetchrow_array;</strong></p><p><strong>  # $nonleaver is from a left join on midYearProg table - if it's not null, the program is mid-year, so we don't flag a leaver</strong></p><p><strong>  return 'N' if defined $nonleaver;</strong></p><p><strong>  # $uoms is 1: years; 2: months; 3: weeks - if missing, assume leaver (all recent programs have UOMS defined)</strong></p><p><strong>  return 'Y' unless defined $uoms;</strong></p><p><strong>  return $yr_course &gt;= $length ? 'Y' : 'N' if $uoms == 1;</strong></p><p><strong>  return $yr_course &gt;= $length / 12 ? 'Y' : 'N' if $uoms == 2;</strong></p><p><strong>  return $yr_course &gt;= $length / 52 ? 'Y' : 'N' if $uoms == 3;</strong></p><p><strong>  # catch-all</strong></p><p><strong>  return 'N';</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub prepareStudentPersonSQL {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong> </strong></p><p><strong>  $studentPersonSQLprepared = 1;</strong></p><p><strong>  # prepare SQL statement to select final-year student from table prog (use handle $leaveh) - used by set_leaver</strong></p><p><strong>  $leaveh = $dbh -&gt; prepare (q{select p.SPLENGTH, p.UOMS, m.PROGRAM from prog p left join midYearProg m on m.PROGRAM = p.PROGRAM where p.PROGRAM = ?}) or die $leaveh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to select from person table (use handle $selh)</strong></p><p><strong>  $selh = $dbh -&gt; prepare (q{select personID, Initials, RealName, sos_code, person_status_code, dept_code, forenames, qual_aim_code, person_state, importID, yr_student, yr_course, acad_sess, reg_status, leaver_flag, pidm, title, program, stu_term, stu_levl, stu_styp, stu_degc, stu_block, stu_stst, stu_ests, stu_att, start_date, end_date, preferredName, b_date from person where rollnumber = ? and person_status_code in ('N', 'U', 'P', 'X')}) or die $selh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to insert into person table (use handle $insh)</strong></p><p><strong>  # source_code is 'S' for Student Records</strong></p><p><strong>  $insh = $dbh -&gt; prepare (q{insert into person (Initials, RealName, source_code, rollnumber, SPRIDEN_ID, sos_code, person_status_code, dept_code, forenames, qual_aim_code, person_state, importID, first_importID, yr_student, yr_course, acad_sess, reg_status, leaver_flag, pidm, title, program, stu_term, stu_levl, stu_styp, stu_degc, stu_block, stu_stst, stu_ests, stu_att, start_date, end_date, preferredName, b_date, is_alumnus) values (?, ?, 'S', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)}) or die $insh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to update person table (use handle $updh)</strong></p><p><strong>  $updh = $dbh -&gt; prepare (q{update person set importID = ?, source_code = 'S', Initials = ?, RealName = ?, SPRIDEN_ID = ?, sos_code = ?, person_status_code = ?, dept_code = ?, forenames = ?, qual_aim_code = ?, person_state = ?, yr_student = ?, yr_course = ?, acad_sess = ?, reg_status = ?, leaver_flag = ?, pidm = ?, title = ?, program = ?, stu_term = ?, stu_levl = ?, stu_styp = ?, stu_degc = ?, stu_block = ?, stu_stst = ?, stu_ests = ?, stu_att = ?, start_date = ?, end_date = ?, preferredName = ?, b_date = ?, is_alumnus = ? where personID = ?}) or die $updh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to insert into person_change (use handle $logh)</strong></p><p><strong>  $logh = $dbh -&gt; prepare (q{insert into person_change (importID, personID, field_name, old_field_value, new_field_value) values (?, ?, ?, ?, ?)}) or die $logh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to insert into person_add (use handle $addh)</strong></p><p><strong>  $addh = $dbh -&gt; prepare (q{insert into person_add (importID, rollnumber) values (?, ?)}) or die $addh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to select personID from extension table (use handle $exth)</strong></p><p><strong>  $exth = $dbh -&gt; prepare (q{select personID from extension where personID = ?}) or die $exth -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to insert into person_rejected_data (use handle $rejh)</strong></p><p><strong>  $rejh = $dbh -&gt; prepare (q{insert into person_rejected_data (importID, rollnumber, field_name, bad_field_value) values (?, ?, ?, ?)}) or die $rejh -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub logchange {</strong></p><p><strong>  my ($importID, $personID, $name, $old_value, $value) = @_;</strong></p><p><strong>  $change = 1;</strong></p><p><strong>  $value = '  (NULL)' unless defined $value;</strong></p><p><strong>  $logh -&gt; execute ($importID, $personID, $name, $old_value, $value) or die $logh -&gt; errstr;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub logrejected {</strong></p><p><strong>  my ($importID, $rollnumber, $name, $value) = @_;</strong></p><p><strong>  $rejh -&gt; execute ($importID, $rollnumber, $name, $value) or die $rejh -&gt; errstr;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub retrieveImportID {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  $sth = $dbh -&gt; prepare (q{select max(importID) from person_import where source_code = 'S' and completed = 'Y'}) or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute or die $sth -&gt; errstr;</strong></p><p><strong>  return $sth -&gt; fetchrow_array;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub generateImportID {</strong></p><p><strong>  my ($dbh) = @_;</strong></p><p><strong>  $sth = $dbh -&gt; prepare (q{insert into person_import (source_code) values ('S')}) or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute or die $sth -&gt; errstr;</strong></p><p><strong>  return $sth -&gt; {mysql_insertid} or die $sth -&gt; errstr;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub completeImport {</strong></p><p><strong>  my ($dbh, $importID) = @_;</strong></p><p><strong>  $sth = $dbh -&gt; prepare (q{update person_import set completed = 'Y' where importID = ?}) or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute ($importID) or die $sth -&gt; errstr;</strong></p><p><strong>}</strong></p><p><strong>1;</strong></p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><ol><li><strong>4.    </strong><strong><u>Changes to disableAccount.pl script (part of Requirement SW838-01)</u></strong></li></ol><p> </p><p><strong>Changes already made by Andy Jones</strong></p><p> </p><p><strong>Changes to be made by Julia</strong></p><p> </p><p><strong>Debugging by Julia</strong></p><p> </p><p> </p><p><strong>#!perl</strong></p><p><strong> </strong></p><p><strong># disableAccount.pl - disable account</strong></p><p><strong>#</strong></p><p><strong># $trID = disableAccount ($dbh, $accID, $reason, $cure)</strong></p><p><strong>#   sets 'failed' or 'disabled' state, disabledReason, disabledCure provided account state is suitable</strong></p><p><strong>#   cure defaults to reason; reason defaults to 'Unknown reason'</strong></p><p><strong>#   and always sets all account_details to disabled</strong></p><p><strong>#   and always issues disable transaction</strong></p><p><strong>#</strong></p><p><strong># 2004-08-17 ARG 1 initial version</strong></p><p><strong># 2004-09-16 ARG 2 allow already disabled accounts to remain disabled</strong></p><p><strong># 2004-11-12 ARG 3 pass disabledReason as a transaction parameter. Correct call to finishDB.</strong></p><p><strong># 2005-04-06 ARG 4 Don't disable non-existent or deleted accounts.</strong></p><p><strong># 2008-12-15 ARG 5 Don't disable invalid accounts (as this now means IDM), and add sensible defaults for some other states.</strong></p><p><strong># 2010-07-20 APB 6 Mods for LIVE/TEST/DEV environments</strong></p><p><strong># 2010-07-20 APB 7 Mods for type 62 disable Live@Edu email account transaction</strong></p><p><strong> </strong></p><p><strong>use warnings;</strong></p><p><strong>use strict;</strong></p><p><strong>use DBI;</strong></p><p><strong> </strong></p><p><strong>use lib ('lib', '../lib');</strong></p><p><strong>require 'generateTransaction.pl';</strong></p><p><strong>require 'connect.pl';</strong></p><p><strong> </strong></p><p><strong>sub disableAccount {</strong></p><p><strong>  my ($dbh, $accID, $disable_edu_account, $reason, $cure) = @_;</strong></p><p><strong> </strong></p><p><strong>  #--------------------------------------------------------------------------------</strong></p><p><strong>  #LIVE/TEST/DEV</strong></p><p><strong> </strong></p><p><strong>  # Note: really ought to uses paths.pl to set $logdir - FUTURE MOD</strong></p><p><strong> </strong></p><p><strong>  my $apb_logfile = &quot;D:/accman/logs/enableAccount.pl.log&quot;;  #LIVE/TEST</strong></p><p><strong>  #my $apb_logfile = 'G:\andyb\email_shadow_folders\b_Current\Major\u_accman_code_and_testbed_and_notes\accmanbe_testbed\D\accman\logs';#DEV</strong></p><p><strong> </strong></p><p><strong>  #my $apb_logfile = &quot;$logdir/enableAccount.pl.log&quot;;    #FUTURE MOD</strong></p><p><strong> </strong></p><p><strong>  #--------------------------------------------------------------------------------</strong></p><p><strong> </strong></p><p><strong>  my ($selstateh, $upstateh, $upaccdeth, $selparamh, $edu_selparamh);</strong></p><p><strong>  my $trID = 0;</strong></p><p><strong> </strong></p><p><strong>  if ($disable_edu_account == 1)</strong></p><p><strong>  {</strong></p><p><strong>    # get old state and thus the new (disabled or equivalent) state</strong></p><p><strong>    $selstateh = $dbh -&gt; prepare (q{select state from account where accID = ?}) or die $selstateh -&gt; errstr;</strong></p><p><strong>    $selstateh -&gt; execute ($accID) or die $selstateh -&gt; errstr;</strong></p><p><strong>    my ($oldState) = $selstateh -&gt; fetchrow_array;</strong></p><p><strong> </strong></p><p><strong>    # can't disable this account - doesn't exist or is flagged 'deleted' or 'invalid'</strong></p><p><strong>    if (not defined $oldState or $oldState =~ m/deleted|invalid/) {</strong></p><p><strong>      finishDB ($dbh, $selstateh);</strong></p><p><strong>      return 0;</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    my $state = ($oldState =~ /valid|disabled/) ? 'disabled' : ($oldState =~ /printed|used|assigned|failed/) ? 'failed' : ($oldState =~ /new|expired/) ? 'expired' : ($oldState =~ /creating|deletable/) ? 'deletable' : ($oldState =~ /deleting/) ? 'deleting' : undef;</strong></p><p><strong> </strong></p><p><strong>    if (defined $state) {</strong></p><p><strong>      # can update account record - set sensible defaults for reason and cure if undefined</strong></p><p><strong>      $reason = 'Unknown reason' unless defined $reason;</strong></p><p><strong>      $cure = $reason unless defined $cure;</strong></p><p><strong>      $upstateh = $dbh -&gt; prepare (q{update account set state = ?, disabledReason = ?, disabledCure = ? where accID = ?}) or die $upstateh -&gt; errstr;</strong></p><p><strong>      $upstateh -&gt; execute ($state, $reason, $cure, $accID) or die $upstateh -&gt; errstr;</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    # update account_details records</strong></p><p><strong>    $upaccdeth = $dbh -&gt; prepare (q{update account_details set disabled = 'Y', disdate = now() where accID = ? and (disabled != 'Y' or disdate is null)}) or die $upaccdeth -&gt; errstr;</strong></p><p><strong>    $upaccdeth -&gt; execute ($accID) or die $upaccdeth -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>    # disable transaction tr_type = 12; params 'username', 'context', 'disabledReason'</strong></p><p><strong>    $selparamh = $dbh -&gt; prepare (q{select username, defaultContext context, disabledReason from account a, department_status d where a.department_status_code = d.department_status_code and accID = ?}) or die $selparamh -&gt; errstr;</strong></p><p><strong>    $selparamh -&gt; execute ($accID) or die $selstateh -&gt; errstr; #### APB - error??? - c/$selstateh/$selparamh/???!!!</strong></p><p><strong>    my $transactionParams = $selparamh -&gt; fetchrow_hashref;</strong></p><p><strong>    $trID = generateTransaction ($dbh, 12, $accID, %$transactionParams);</strong></p><p><strong> </strong></p><p><strong>    #APB</strong></p><p><strong>    print &quot;disableAccount.pl - about to generate type 62 tx\n&quot;;</strong></p><p><strong> </strong></p><p><strong>    # Disable Live@Edu account - transaction tr_type = 62; params 'identity'</strong></p><p><strong>    $edu_selparamh = $dbh -&gt; prepare (q{select concat(a.primary_mailname, '@', ed.domainName) identity from account a, emailDomain ed where a.primary_domainID = ed.domainID and accID = ?}) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>    $edu_selparamh -&gt; execute ($accID) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>    my $edu_transactionParams = $edu_selparamh -&gt; fetchrow_hashref;</strong></p><p><strong>    my $edu_trID = generateTransaction ($dbh, 62, $accID, %$edu_transactionParams);</strong></p><p><strong> </strong></p><p><strong>    #APB</strong></p><p><strong>    print &quot;disableAccount.pl - edu_trID=$edu_trID\n&quot;;</strong></p><p><strong>  }</strong></p><p><strong>  else</strong></p><p><strong>  {</strong></p><p><strong>    print &quot;disableAccount.pl – student is an alumnus, so email account has not been disabled.\n&quot;;</strong></p><p><strong>    # disableAccount.pl - about to generate tx type 122 to hide email addr in Live@Edu list; params 'identity'</strong></p><p><strong>    print &quot;disableAccount.pl – about to generate tx type 122 to hide email addr in Live</strong><strong>At</strong><strong>Edu list.\n&quot;;</strong></p><p><strong> </strong></p><p><strong>    $edu_selparamh = $dbh -&gt; prepare (q{select concat(a.primary_mailname, '@', ed.domainName) identity from account a, emailDomain ed where a.primary_domainID = ed.domainID and accID = ?}) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>    $edu_selparamh -&gt; execute ($accID) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>    my $edu_transactionParams = $edu_selparamh -&gt; fetchrow_hashref;</strong></p><p><strong>    my $edu_trID = generateTransaction ($dbh, 122, $accID, %$edu_transactionParams);</strong></p><p><strong>    print &quot;disableAccount.pl - edu_trID=$edu_trID\n&quot;;</strong></p><p><strong> </strong></p><p><strong>  }</strong></p><p><strong> </strong></p><p><strong>  finishDB ($dbh, $selstateh, $upstateh, $upaccdeth, $selparamh, $edu_selparamh);</strong></p><p><strong>  return $trID;</strong></p><p><strong>}</strong></p><p><strong>1; # required by require (see manual)</strong></p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><ol><li><strong>5.    </strong><strong><u>Changes to \scripts\scheduled\SISImport\studentautostate.pl script (part of Requirement SW838-01)</u></strong></li></ol><p> </p><p><strong>Changes already made by Andy Jones</strong></p><p> </p><p><strong>Changes to be made by Julia</strong></p><p> </p><p> </p><p><strong>#! perl -w</strong></p><p><strong>#</strong></p><p><strong># studentautostate.pl</strong></p><p><strong>#</strong></p><p><strong># disable accounts where student is now absent or left</strong></p><p><strong># re-enable accounts where student is now present</strong></p><p><strong>#</strong></p><p><strong># 2003-09-09 ARG 1 Initial version</strong></p><p><strong># 2003-11-13 ARG 2 Add extendReason to list of permissible accounts to re-enable</strong></p><p><strong># 2003-12-18 ARG 3 Add description of stu_ests to disabledCure. CR 1026.</strong></p><p><strong># 2004-07-28 ARG 4 Add join on dept_person_account to see if account is in correct dept.</strong></p><p><strong># 2004-11-17 ARG 5 Use library connect, disableAccount, enableAccount. Update $session.</strong></p><p><strong># 2006-09-05 ARG 6 Update $session.</strong></p><p><strong># 2007-06-21 ARG 7 Add logic for 'graduating' person_state -  RFC 0053.</strong></p><p><strong># 2007-08-09 ARG 8 Update $session.</strong></p><p><strong># 2008-06-10 ARG 9 Automate $session.</strong></p><p><strong># 2010-06-01 APB 10 Add logging - commented out.</strong></p><p><strong># 2010-06-02 APB 11 logging - un-comment.</strong></p><p><strong># 2010-06-07 APB 12 more logging.</strong></p><p><strong># 2010-06-08 APB 13 more logging.</strong></p><p><strong># 2011-03-28 APB #14# Mods for LIVE/TEST/DEV</strong></p><p><strong># 2011-09-15 APB #15#  Change username and password</strong></p><p><strong> </strong></p><p><strong>use warnings;</strong></p><p><strong>use strict;</strong></p><p><strong>use DBI;</strong></p><p><strong> </strong></p><p><strong>use lib ('lib', '../lib', '../../lib', '../../../lib');</strong></p><p><strong>require 'connect.pl';</strong></p><p><strong>require 'disableAccount.pl';</strong></p><p><strong>require 'enableAccount.pl';</strong></p><p><strong>require 'generateTransaction.pl';</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong># APB 2010-06-01</strong></p><p><strong># [copied from C:\accman\scripts\standard.pl]</strong></p><p><strong># define logfile and its logging subs</strong></p><p><strong>our ($logfile);</strong></p><p><strong>require 'trLogging.pl';</strong></p><p><strong>$logfile = 'D:/accman/logs/apb_studentautostate.log';</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>#APB 07/06/2010</strong></p><p><strong>#my $apb_logfile = &quot;$logdir/assign.pl.log&quot;;</strong></p><p><strong>my $apb_logfile = &quot;D:/accman/logs/studentautostate.pl.log&quot;;</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>our ($DEV, $logdir, $updir);</strong></p><p><strong>our ($jrbpath, $gpaspath);</strong></p><p><strong>our ($DB, $usernameDB, $passwordDB);</strong></p><p><strong> </strong></p><p><strong>require 'paths.pl';</strong></p><p><strong> </strong></p><p><strong># make all database handles global</strong></p><p><strong>my ($dbh, $selimph, $selenah, $selen2h, $seldish);</strong></p><p><strong> </strong></p><p><strong>my $leftReason = 'Student has left';</strong></p><p><strong>my $absentReason = 'Student is absent';</strong></p><p><strong>my $extendReason = 'User has left - extension expired';</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong># LIVE/TEST/DEV</strong></p><p><strong>if ($DEV) {</strong></p><p><strong>  ($DB, $usernameDB, $passwordDB) = ('TestMail', 'alan', 'huc8er');</strong></p><p><strong>} else {</strong></p><p><strong>#15# ($DB, $usernameDB, $passwordDB) = ('Mail', 'personimport', 'banner-SAP');</strong></p><p><strong>  ($DB, $usernameDB, $passwordDB) = ('Mail', 'netware', 'back-enD');</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong>my $inc;</strong></p><p><strong>if (defined $ARGV[0] and ($ARGV[0] =~ m/-inc/i)) {</strong></p><p><strong>  $inc = shift;</strong></p><p><strong>}</strong></p><p><strong>my $session = sessionnow();</strong></p><p><strong>$session-- unless $inc;</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>#APB 2010-06-08</strong></p><p><strong>apb_logactivity_tofile( $apb_logfile, &quot;APB studentautostate.pl - about to connect to databases&quot; );</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>$dbh = connectDB ($usernameDB, $passwordDB, $DB);</strong></p><p><strong> </strong></p><p><strong>prepareSQL ($session);</strong></p><p><strong> </strong></p><p><strong># get last student importID to identify transactions</strong></p><p><strong>$selimph -&gt; execute () or die $selimph -&gt; errstr;</strong></p><p><strong>my ($importID) = $selimph -&gt; fetchrow_array;</strong></p><p><strong> </strong></p><p><strong>our $trCallerID = &quot;imp $importID&quot;;</strong></p><p><strong> </strong></p><p><strong>my $enableCount = enable ();</strong></p><p><strong>my $disableCount = disable ();</strong></p><p><strong> </strong></p><p><strong>print &quot;$enableCount accounts enabled\n&quot;;</strong></p><p><strong>print &quot;$disableCount accounts disabled\n&quot;;</strong></p><p><strong> </strong></p><p><strong># APB 2010-06-01</strong></p><p><strong>#logtext( &quot;studentautostate.pl - $enableCount accounts enabled&quot; );</strong></p><p><strong>#logtext( &quot;studentautostate.pl - $disableCount accounts disabled&quot; );</strong></p><p><strong>logactivity( &quot;APB studentautostate.pl - $enableCount accounts enabled&quot; );</strong></p><p><strong>logactivity( &quot;APB studentautostate.pl - $disableCount accounts disabled&quot; );</strong></p><p><strong>#Note: logactivity is like logtext but with a date/time prefix</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>apb_logactivity_tofile( $apb_logfile, &quot;APB studentautostate.pl - $enableCount accounts enabled&quot; );</strong></p><p><strong>apb_logactivity_tofile( $apb_logfile, &quot;APB studentautostate.pl - $disableCount accounts disabled&quot; );</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>disconnectDB ($dbh, $selimph, $selenah, $selen2h, $seldish);</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>#APB 2010-06-08</strong></p><p><strong>apb_logactivity_tofile( $apb_logfile, &quot;APB studentautostate.pl - disconnected from databases&quot; );</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub enable {</strong></p><p><strong>  # enable relevant accounts for students who have returned</strong></p><p><strong>  my %explanation = (</strong></p><p><strong>    present =&gt; 'Student has returned',</strong></p><p><strong>    graduating =&gt; 'Student is graduating');</strong></p><p><strong>  my $count = 0;</strong></p><p><strong>  my $trID;</strong></p><p><strong>  $selenah -&gt; execute () or die $selenah -&gt; errstr;</strong></p><p><strong>  while (my ($accID, $user, $person_state, $personID) = $selenah -&gt; fetchrow_array) {</strong></p><p><strong> </strong></p><p><strong>    #             candidate for re-enabling</strong></p><p><strong> </strong></p><p><strong>    $selen2h -&gt; execute ($personID, $accID) or die $selen2h -&gt; errstr;</strong></p><p><strong>    if (my ($user2) = $selen2h -&gt; fetchrow_array) {</strong></p><p><strong>      #             student already has a valid personal account of the right type in the correct school</strong></p><p><strong>      #             re-label the left/absent one so we won't try to re-enable it again - no harm in trying to disable it as well</strong></p><p><strong>      $trID = disableAccount ($dbh, $accID, true, &quot;Now using $user2&quot;);</strong></p><p><strong>      print &quot;$user disabledReason changed: Now using $user2\n&quot;;</strong></p><p><strong>    } else {</strong></p><p><strong>      #             student's only candidate account - re-enable it</strong></p><p><strong>      $trID = enableAccount ($dbh, $accID, $explanation{$person_state});</strong></p><p><strong>      print &quot;$user enabled (transaction $trID): $explanation{$person_state}\n&quot;;</strong></p><p><strong>      $count++;</strong></p><p><strong> </strong></p><p><strong>      apb_logactivity_tofile( $apb_logfile, &quot;APB studentautostate.pl - enable account $user - trId=$trID [$explanation{$person_state}]&quot; );</strong></p><p><strong> </strong></p><p><strong>      # student is returning, so we need to set the person.is_alumnus flag to false and unhide their email address in global address lists</strong></p><p><strong>      print &quot;about to set is_alumnus flag to false for returning student, personID: $personID\n&quot;;</strong></p><p><strong>      $updisalh -&gt; execute ($personID) or die $selenah -&gt; errstr;</strong></p><p><strong> </strong></p><p><strong>      # studentautostate.pl - about to generate tx type 124 to unhide email addr in global lists for returning student; params 'identity'</strong></p><p><strong>      print &quot;about to unhide email address in global address lists false for returning student, personID: $personID\n&quot;;</strong></p><p><strong> </strong></p><p><strong>      $edu_selparamh = $dbh -&gt; prepare (q{select concat(a.primary_mailname, '@', ed.domainName) identity from account a, emailDomain ed where a.primary_domainID = ed.domainID and accID = ?}) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>      $edu_selparamh -&gt; execute ($accID) or die $edu_selparamh -&gt; errstr;</strong></p><p><strong>      my $edu_transactionParams = $edu_selparamh -&gt; fetchrow_hashref;</strong></p><p><strong>      my $edu_trID = generateTransaction ($dbh, 124, $accID, %$edu_transactionParams);</strong></p><p><strong>      print &quot;studentautostate.pl - edu_trID=$edu_trID\n&quot;;</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>    }</strong></p><p><strong>  }</strong></p><p><strong>  return $count;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub disable {</strong></p><p><strong>  # disable all accounts of students who have left or are not currently active</strong></p><p><strong>  my %reason = (</strong></p><p><strong>    left =&gt; $leftReason,</strong></p><p><strong>    absent =&gt; $absentReason);</strong></p><p><strong>  my %cure = getCurehash (%reason);</strong></p><p><strong>  my $count = 0;</strong></p><p><strong>  my $trID;</strong></p><p><strong>  my $is_alumnus = 0;</strong></p><p><strong>  $seldish -&gt; execute () or die $seldish -&gt; errstr;</strong></p><p><strong>  while (my ($accID, $user, $person_state, $stu_ests, $is_alumnus) = $seldish -&gt; fetchrow_array) {</strong></p><p><strong>    # if the student is an alumnus, then set flag so their email account is not disabled</strong></p><p><strong>    if ($is_alumnus =</strong><strong>=</strong><strong> 1){</strong></p><p><strong>        print &quot;studentautostate.pl – student is alumnus, so email account will not be disabled.\n&quot;;</strong></p><p><strong>        $disable_edu_account = 0;</strong></p><p><strong>    }</strong></p><p><strong>    else {</strong></p><p><strong>         print &quot;studentautostate.pl – student is not alumnus, so email account will be disabled.\n&quot;;</strong></p><p><strong>        $disable_edu_account = 1;</strong></p><p><strong>    }</strong></p><p><strong> </strong></p><p><strong>    # disable the account</strong></p><p><strong>    <span style="text-decoration: line-through;">$trID = disableAccount ($dbh, $accID, true, $reason{$person_state}, $cure{$stu_ests});</span></strong></p><p><strong>    $trID = disableAccount ($dbh, $accID, $disable_edu_account, $reason{$person_state}, $cure{$stu_ests});</strong></p><p><strong> </strong></p><p><strong>    print &quot;$user disabled (transaction $trID): $reason{$person_state}\n&quot;;</strong></p><p><strong>    $count++;</strong></p><p><strong>  }</strong></p><p><strong>  return $count;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub getCurehash {</strong></p><p><strong>  my (%reason) = @_;</strong></p><p><strong>  # set up hash to determine disabledCure from stu_ests code and its person_state</strong></p><p><strong>  my %cure = ();</strong></p><p><strong>  my $sth;</strong></p><p><strong>  $sth = $dbh -&gt; prepare('select stu_ests, ests_desc, person_state from student_ests') or die $sth -&gt; errstr;</strong></p><p><strong>  $sth -&gt; execute () or die $sth -&gt; errstr;</strong></p><p><strong>  while (my ($ests, $desc, $person_state) = $sth -&gt; fetchrow_array) {</strong></p><p><strong>    if ($person_state =~ m/present|expected/) {</strong></p><p><strong>      $cure {$ests} = &quot;$reason{'left'} - was $desc ($ests)&quot;;</strong></p><p><strong>    } else {</strong></p><p><strong>      $cure {$ests} = &quot;$reason{$person_state} - $desc ($ests)&quot;;</strong></p><p><strong>    }</strong></p><p><strong>  }</strong></p><p><strong>  finishDB ($dbh, $sth);</strong></p><p><strong>  return %cure;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>sub prepareSQL {</strong></p><p><strong>  my ($session) = @_;</strong></p><p><strong> </strong></p><p><strong>  my $selimp = q{select importID from person_import where source_code = 'S' and completed = 'Y' order by importID desc limit 1};</strong></p><p><strong> </strong></p><p><strong>  #             </strong></p><p><strong>  my $selena = qq{select a.accID, a.username, p.person_state, p.personID from account a, person p, department_status ds, dept_person_account d where p.personID = a.personID and p.person_state in ('present', 'graduating') and p.source_code = 'S' and p.acad_sess &gt;= $session and ((p.person_status_code in ('N', 'U') and a.status_code &lt; 'P') or (p.person_status_code = 'P' and a.status_code in ('P', 'Q'))) and a.state in ('disabled', 'deletable') and a.accountType = 'personal' and a.department_status_code = ds.department_status_code and p.dept_code = d.person_dept_code and ds.dept_code = d.account_dept_code and a.disabledReason in ('$leftReason', '$absentReason', '$extendReason', 'Student has probably left')};</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>  my $selen2 = q{select a.username from account a, person p, department_status ds, dept_person_account d where p.personID = ? and p.personID = a.personID and ((p.person_status_code in ('N', 'U') and a.status_code &lt; 'P') or (p.person_status_code = 'P' and a.status_code in ('P', 'Q'))) and a.state = 'valid' and a.accountType = 'personal' and a.department_status_code = ds.department_status_code and p.dept_code = d.person_dept_code and ds.dept_code = d.account_dept_code and a.accID != ?};</strong></p><p><strong>  my $seldis = qq{select a.accID, a.username, p.person_state, p.stu_ests, p.is_alumnus from account a, person p, department_status ds where p.personID = a.personID and p.person_state in ('absent', 'left') and p.source_code = 'S' and p.acad_sess &gt;= $session and a.state = 'valid' and a.accountType = 'personal' and a.department_status_code = ds.department_status_code};</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>  # prepare SQL statement to update person table to set is_alumnus flag to false (use handle $updisalh)</strong></p><p><strong>  $updisalh = $dbh -&gt; prepare (q{update person set is_alumnus = 0 where personID = ?});</strong></p><p><strong> </strong></p><p><strong> </strong></p><p><strong>  $selimph = $dbh -&gt; prepare ($selimp) or die $selimph -&gt; errstr;</strong></p><p><strong>  $selenah = $dbh -&gt; prepare ($selena) or die $selenah -&gt; errstr;</strong></p><p><strong>  $selen2h = $dbh -&gt; prepare ($selen2) or die $selen2h -&gt; errstr;</strong></p><p><strong>  $seldish = $dbh -&gt; prepare ($seldis) or die $seldish -&gt; errstr;</strong></p><p><strong>  $updisalh = $dbh -&gt; prepare ($updisal) or die $updisalh -&gt; errstr;</strong></p><p><strong>}</strong></p><p><strong> </strong></p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p align="center"><strong><u>Quartz Jobs</u></strong></p><p> </p><p> </p><pre>HIDE_IN_EMAIL_ADDRESS_LISTS = 122</pre><p><strong>      </strong></p><p>UNHIDE_IN_EMAIL_ADDRESS_LISTS = 124</p><p> </p><p> </p><p>HIDE_IN_EMAIL_ADDRESS_LISTS = 122</p><p>===================================</p><p> </p><p> </p><p>   &lt;job&gt;</p><p>    &lt;job-detail&gt;</p><p>      &lt;name&gt;122&lt;/name&gt;</p><p>      &lt;group&gt;AccMan&lt;/group&gt;</p><p>      &lt;description&gt;Transaction 122 - Hide In Email Address Lists&lt;/description&gt;</p><p>      &lt;job-type&gt;Salford.Library.SchedulerService.Model.SerialServiceProcess, SchedulerServiceLibrary&lt;/job-type&gt;</p><p>      &lt;volatile&gt;false&lt;/volatile&gt;</p><p>      &lt;durable&gt;false&lt;/durable&gt;</p><p>      &lt;recover&gt;false&lt;/recover&gt;</p><p>      &lt;job-data-map&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ID&lt;/key&gt;</p><p>          &lt;value&gt;122&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;DllFile&lt;/key&gt;</p><p>          &lt;value&gt;C:\AccManBackEndLibrary\AccManBackEndLibrary.dll&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ClassName&lt;/key&gt;</p><p>          &lt;value&gt;Salford.AccMan.BackEnd.Processes.StudentEmail.HideInEmailAddressLists&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;AccManDatabase&lt;/key&gt;</p><p>          &lt;value&gt;Server=uos-t-rhel-03.isdads.salford.ac.uk;Uid=accman;Pwd=w3w2g,wnam!;Database=mail;&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;AssociateDatabase&lt;/key&gt;</p><p>          &lt;value&gt;Server=uos-t-rhel-03.isdads.salford.ac.uk;Uid=accman;Pwd=w3w2g,wnam!;Database=associates;&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;LogLevel&lt;/key&gt;</p><p>          &lt;value&gt;Debug&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;LogDirectory&lt;/key&gt;</p><p>          &lt;value&gt;C:\Logs\HideInEmailAddressLists&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;          </p><p>        &lt;!-- DO NOT SET THIS IN PRODUCTION (or at least set it to FALSE) --&gt; </p><p>          &lt;key&gt;SkipSecurityChecks&lt;/key&gt;</p><p>          &lt;value&gt;TRUE&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;</p><p>        &lt;!-- What authentication method to use when connecting to Exchange. Currently supports 'Basic' and 'Kerberos' --&gt;</p><p>          &lt;key&gt;ExchangeAuthenticationMethod&lt;/key&gt;</p><p>          &lt;value&gt;Basic&lt;/value&gt;</p><p>      &lt;/entry&gt;           </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeUsername&lt;/key&gt;</p><p>          &lt;value&gt;tad1.test\svc-tst-accman&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangePassword&lt;/key&gt;</p><p>          &lt;value&gt;P4ssw0rd&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeURI&lt;/key&gt;</p><p>          &lt;value&gt;<a href="https://uos-t-exch-01.tad1.test/PowerShell" class="external-link" rel="nofollow">https://uos-t-exch-01.tad1.test/PowerShell</a>&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeSchemaURI&lt;/key&gt;</p><p>          &lt;value&gt;<a href="http://schemas.microsoft.com/powershell/Microsoft.Exchange" class="external-link" rel="nofollow">http://schemas.microsoft.com/powershell/Microsoft.Exchange</a>&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;DomainController&lt;/key&gt;</p><p>          &lt;value&gt;uos-t-domc-01.tad1.test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADConfigRoot&lt;/key&gt;</p><p>          &lt;value&gt;CN=Configuration,DC=tad1,DC=test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADHost&lt;/key&gt;</p><p>          &lt;value&gt;146.87.145.200&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADRoot&lt;/key&gt;</p><p>          &lt;value&gt;DC=TAD1,DC=TEST&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADUserBase&lt;/key&gt;</p><p>          &lt;value&gt;OU=Students,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADFunctionalPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Functional,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;  </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADStaffPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Staff,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADStudentPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Students,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;</p><p>          &lt;key&gt;ADUnknownPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Other,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;        </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADUsername&lt;/key&gt;</p><p>          &lt;value&gt;CN=aUIS894,OU=Test,DC=tad1,DC=test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADPassword&lt;/key&gt;</p><p>          &lt;value&gt;Password1946&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;TransactionLogDirectory&lt;/key&gt;</p><p>          &lt;value&gt;C:\Logs\TransactionLogs&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;Limit&lt;/key&gt;</p><p>          &lt;value&gt;1000&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;/job-data-map&gt;</p><p>    &lt;/job-detail&gt;</p><p> </p><p>    &lt;trigger&gt;</p><p>      &lt;cron&gt;</p><p>        &lt;name&gt;122-cron-trigger&lt;/name&gt;</p><p>        &lt;job-name&gt;122&lt;/job-name&gt;</p><p>        &lt;cron-expression&gt;0/5 * * * * ?&lt;/cron-expression&gt;</p><p>        &lt;misfire-instruction&gt;DoNothing&lt;/misfire-instruction&gt;</p><p>      &lt;/cron&gt;</p><p>    &lt;/trigger&gt;</p><p>  &lt;/job&gt;</p><p> </p><p> </p><p> </p><p> </p><p>UNHIDE_IN_EMAIL_ADDRESS_LISTS = 124</p><p>===================================</p><p> </p><p> </p><p> </p><p>   &lt;job&gt;</p><p>    &lt;job-detail&gt;</p><p>      &lt;name&gt;124&lt;/name&gt;</p><p>      &lt;group&gt;AccMan&lt;/group&gt;</p><p>      &lt;description&gt;Transaction 124 - Unhide In Email Address Lists&lt;/description&gt;</p><p>      &lt;job-type&gt;Salford.Library.SchedulerService.Model.SerialServiceProcess, SchedulerServiceLibrary&lt;/job-type&gt;</p><p>      &lt;volatile&gt;false&lt;/volatile&gt;</p><p>      &lt;durable&gt;false&lt;/durable&gt;</p><p>      &lt;recover&gt;false&lt;/recover&gt;</p><p>      &lt;job-data-map&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ID&lt;/key&gt;</p><p>          &lt;value&gt;124&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;DllFile&lt;/key&gt;</p><p>          &lt;value&gt;C:\AccManBackEndLibrary\AccManBackEndLibrary.dll&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ClassName&lt;/key&gt;</p><p>          &lt;value&gt;Salford.AccMan.BackEnd.Processes.StudentEmail.UnhideInEmailAddressLists&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;AccManDatabase&lt;/key&gt;</p><p>          &lt;value&gt;Server=uos-t-rhel-03.isdads.salford.ac.uk;Uid=accman;Pwd=w3w2g,wnam!;Database=mail;&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;AssociateDatabase&lt;/key&gt;</p><p>          &lt;value&gt;Server=uos-t-rhel-03.isdads.salford.ac.uk;Uid=accman;Pwd=w3w2g,wnam!;Database=associates;&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;LogLevel&lt;/key&gt;</p><p>          &lt;value&gt;Debug&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;LogDirectory&lt;/key&gt;</p><p>          &lt;value&gt;C:\Logs\UnhideInEmailAddressLists&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;          </p><p>        &lt;!-- DO NOT SET THIS IN PRODUCTION (or at least set it to FALSE) --&gt; </p><p>          &lt;key&gt;SkipSecurityChecks&lt;/key&gt;</p><p>          &lt;value&gt;TRUE&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;</p><p>        &lt;!-- What authentication method to use when connecting to Exchange. Currently supports 'Basic' and 'Kerberos' --&gt;</p><p>          &lt;key&gt;ExchangeAuthenticationMethod&lt;/key&gt;</p><p>          &lt;value&gt;Basic&lt;/value&gt;</p><p>      &lt;/entry&gt;           </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeUsername&lt;/key&gt;</p><p>          &lt;value&gt;tad1.test\svc-tst-accman&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangePassword&lt;/key&gt;</p><p>          &lt;value&gt;P4ssw0rd&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeURI&lt;/key&gt;</p><p>          &lt;value&gt;<a href="https://uos-t-exch-01.tad1.test/PowerShell" class="external-link" rel="nofollow">https://uos-t-exch-01.tad1.test/PowerShell</a>&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ExchangeSchemaURI&lt;/key&gt;</p><p>          &lt;value&gt;<a href="http://schemas.microsoft.com/powershell/Microsoft.Exchange" class="external-link" rel="nofollow">http://schemas.microsoft.com/powershell/Microsoft.Exchange</a>&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;DomainController&lt;/key&gt;</p><p>          &lt;value&gt;uos-t-domc-01.tad1.test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADConfigRoot&lt;/key&gt;</p><p>          &lt;value&gt;CN=Configuration,DC=tad1,DC=test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADHost&lt;/key&gt;</p><p>          &lt;value&gt;146.87.145.200&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADRoot&lt;/key&gt;</p><p>          &lt;value&gt;DC=TAD1,DC=TEST&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADUserBase&lt;/key&gt;</p><p>          &lt;value&gt;OU=Students,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADFunctionalPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Functional,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;  </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADStaffPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Staff,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADStudentPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Students,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;entry&gt;</p><p>          &lt;key&gt;ADUnknownPath&lt;/key&gt;</p><p>          &lt;value&gt;OU=Other,OU=Users,OU=Non Datacentre&lt;/value&gt;</p><p>        &lt;/entry&gt;         </p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADUsername&lt;/key&gt;</p><p>          &lt;value&gt;CN=aUIS894,OU=Test,DC=tad1,DC=test&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;ADPassword&lt;/key&gt;</p><p>          &lt;value&gt;Password1946&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;TransactionLogDirectory&lt;/key&gt;</p><p>          &lt;value&gt;C:\Logs\TransactionLogs&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>        &lt;entry&gt;</p><p>          &lt;key&gt;Limit&lt;/key&gt;</p><p>          &lt;value&gt;1000&lt;/value&gt;</p><p>        &lt;/entry&gt;</p><p>      &lt;/job-data-map&gt;</p><p>    &lt;/job-detail&gt;</p><p> </p><p>    &lt;trigger&gt;</p><p>      &lt;cron&gt;</p><p>        &lt;name&gt;124-cron-trigger&lt;/name&gt;</p><p>        &lt;job-name&gt;124&lt;/job-name&gt;</p><p>        &lt;cron-expression&gt;0/5 * * * * ?&lt;/cron-expression&gt;</p><p>        &lt;misfire-instruction&gt;DoNothing&lt;/misfire-instruction&gt;</p><p>      &lt;/cron&gt;</p><p>    &lt;/trigger&gt;</p><p>  &lt;/job&gt;</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p align="center"><strong><u>Summary of Modifications to Perl Scripts</u></strong></p><p> </p><p> </p><p> </p><p><strong>studentPerson.pl</strong></p><p><strong>===============</strong></p><p> </p><p><strong>Purpose:</strong> to set person.is_alumnus to true if the student has a value in SKBHINS_ENDDATE</p><p> </p><p> </p><p> </p><p><strong>disableAccount.pl</strong></p><p><strong>===============</strong></p><p> </p><p><strong>Purpose:</strong> </p><p> </p><ul><li>if variable $disable_edu_account is false (the student is an alumnus) then don't disable the the student's email account,</li></ul><p>          but do generate a 122 transaction type (email identity transaction params should also be generated).</p><p> </p><ul><li>if variable $disable_edu_account is true (the student is not an alumnus) then generate a 62 transaction type (email identity transaction params</li></ul><p>          should also be generated)</p><p> </p><p> </p><p> </p><p><strong>studentautostate.pl</strong></p><p><strong>===================</strong></p><p> </p><p><strong>Purpose:</strong>  </p><p> </p><ul><li>Firstly: if the student is returning then set the person.is_alumnus flag to false and their email addresses are unhidden in the global address lists (also their email acct is re-enabled by the existing code)</li></ul><p> </p><ul><li>Secondly: if the student is an alumnus, then set $disable_edu_account to false, so their email account won't be disabled, <strong>OR</strong> if the student is not an alumnus, then set $disable_edu_account to true, so their email account will be disabled</li></ul><p> </p><p> </p><p> </p><p> </p><p> </p><p align="center"><strong><u>Testing of Perl Scripts</u></strong></p><p> </p><p> </p><ol><li><strong>1.    </strong><strong>Test that the original code still works . . . Disable a student through Accman Front End . . . Run Banner_Import</strong></li></ol><p> </p><p>Expected results:       </p><p> </p><ul><li>The student’s <strong>person.is_alumnus</strong> flag is not set to <strong>true</strong></li><li>A transaction type 62 has been generated in order to disable the student’s email account and the transaction params include the student’s email address</li><li>A transaction type 12 has been generated which populates the reason for disablement.</li><li>The student’s email account has been disabled.</li></ul><p>                                   </p><p> </p><ol><li><strong>2.    </strong><strong>Test that Email for Life works . . . Create a student in Banner who has graduated and who’s SKBHINS_ENDDATE has been set . . . Run Banner_Import</strong></li></ol><p> </p><p>Expected results:</p><p> </p><ul><li>The student’s <strong>person.is_alumnus</strong> flag is set to <strong>true</strong></li><li>A transaction type 122 has been generated in order to hide the student’s email address in the Live@Edu and Outlook global address lists. (<strong>122 = HIDE_IN_EMAIL_ADDRESS_LISTS</strong>) Check that the the transaction params include the student’s email address</li><li>The student’s email address must not be disabled<ul><li>Check that transaction type 12 has <u>not</u> been generated (reason for disablement).</li><li>Check that all the other services (e.g. AD, Blackboard, Library etc.) have been disabled</li></ul></li></ul><p> </p><p> </p><ol><li><strong>3.    </strong><strong>Testing the return of the alumnus student to the University . . .  Modifiy the above student’s Banner account so they are returning to the University (the student is now “present” in accman) . . . Run Banner_Import</strong></li></ol><p> </p><p>Expected results:</p><p> </p><ul><li>The student’s <strong>person.is_alumnus</strong> flag is set to <strong>false</strong></li><li>The student’s email account remains enabled</li><li>All of their other services are enabled  (e.g. AD, Blackboard, Library etc.)</li><li>A transaction type 124 has been generated to unhide the student’s email address in the Live@Edu and Outlook global address lists.  (124 = <strong>UNHIDE_IN_EMAIL_ADDRESS_LISTS</strong>)</li></ul><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p align="center"><strong><u>Hiding &amp; Unhiding Alumnus Email Addresses in the Live@Edu Address List</u></strong></p><p> </p><p> </p><p> </p><p><strong><u>Connecting to UoS Test Live@edu System</u></strong></p><p> </p><p><strong><u>Run PowerShell as Administrator</u></strong></p><p> </p><p><strong>Set-ExecutionPolicy RemoteSigned</strong></p><p><strong> </strong></p><p><strong>netsh winhttp set proxy 146.87.136.147:8080 &quot;&lt;local&gt;&quot;</strong></p><p><strong> </strong></p><p><strong>$secpasswd = ConvertTo-SecureString 'UoSLive2010' -AsPlainText -Force;</strong></p><p><strong> </strong></p><p><strong>$LiveCred = New-Object System.Management.Automation.PSCredential (<a href="http://uos-d-dbld-01:8090/mailto:" class="external-link" rel="nofollow">'admin2@testlive.salford.ac.uk</a>', $secpasswd);</strong></p><p><strong> </strong></p><p><strong>$Script:Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri '<a href="https://ps.outlook.com/powershell/" class="external-link" rel="nofollow">https://ps.outlook.com/powershell/</a>' -Credential $LiveCred -Authentication Basic -AllowRedirection;   </strong></p><p><strong> </strong></p><p><strong>Import-PSSession $Session</strong></p><p><strong>                           </strong></p><p>You can then . . . .    <strong>Get-Mailbox –Identity &lt;identity&gt;   .</strong> . . . etc.</p><p> </p><p>‘<strong>Get-Mailbox</strong>’ alone retrieves the first 1000 entries.</p><p> </p><p><strong>Remove-PSSession $Session</strong></p><p> </p><p> </p><p> </p><p> </p><p>WARNING: Your connection has been redirected to the following URI:</p><p>&quot;<a href="https://pod51002psh.outlook.com/PowerShell-LiveID?PSVersion=2.0" class="external-link" rel="nofollow">https://pod51002psh.outlook.com/PowerShell-LiveID?PSVersion=2.0</a> &quot;</p><p>WARNING: Your connection has been redirected to the following URI:</p><p>&quot;<a href="https://amsprd0104psh.outlook.com/PowerShell-LiveID?PSVersion=2.0" class="external-link" rel="nofollow">https://amsprd0104psh.outlook.com/PowerShell-LiveID?PSVersion=2.0</a> &quot;</p><p>PS C:\Windows\system32&gt;</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>Users in the Test Live@EDU System</u></strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity *test*</p><p> </p><p>Name                      Alias                ServerName       ProhibitSendQuota</p><p>----                      -----                ----------       -----------------</p><p>Maurizio.Gulla-Test       Maurizio.Gulla-Test  amsprd0104mb097  9.668 GB (10,380,902,400 bytes)</p><p>Paul                      P.Robinson           amsprd0104mb098  9.668 GB (10,380,902,400 bytes)</p><p>Andy.Bourne1              Andy.Bourne1         amsprd0104mb098  9.668 GB (10,380,902,400 bytes)</p><p>Paul Brereton             paul.brereton        amsprd0104mb098  9.668 GB (10,380,902,400 bytes)</p><p>Test User [testlive]      testuser             amsprd0104mb099  9.668 GB (10,380,902,400 bytes)</p><p>Chris Clarke              chris.clarke         amsprd0104mb101  9.668 GB (10,380,902,400 bytes)</p><p>sd tester                 sdtester             amsprd0104mb102  9.668 GB (10,380,902,400 bytes)</p><p>Public group test user    Pubgrouptest         amsprd0104mb102  9.668 GB (10,380,902,400 bytes)</p><p>Elivira.Chinea            Elivira.Chinea       amsprd0104mb109  9.668 GB (10,380,902,400 bytes)</p><p>Administrator             admin                amsprd0104mb113  9.668 GB (10,380,902,400 bytes)</p><p>Andy.Bourne-Test          Andy.Bourne-Test     amsprd0104mb113  9.668 GB (10,380,902,400 bytes)</p><p>G.T.Richards              G.T.Richards         amsprd0104mb122  9.668 GB (10,380,902,400 bytes)</p><p>Z.D.Unisys-Testing        Z.D.Unisys-Testing   amsprd0104mb125  9.668 GB (10,380,902,400 bytes)</p><p>M.T.Meaney                M.T.Meaney           amsprd0104mb133  9.668 GB (10,380,902,400 bytes)</p><p>k.j.blow-test             k.j.blow-test        amsprd0104mb135  9.668 GB (10,380,902,400 bytes)</p><p>Service Desk              servicedesk          amsprd0104mb146  9.668 GB (10,380,902,400 bytes)</p><p>Z.C.Unisys-Testing        Z.C.Unisys-Testing   amsprd0104mb150  9.668 GB (10,380,902,400 bytes)</p><p>Admin2                    admin2               amsprd0104mb159  9.668 GB (10,380,902,400 bytes)</p><p>Discovery Mailbox         DiscoveryMailbox     amsprd0104mb160  9.668 GB (10,380,902,400 bytes)</p><p>Paul.Daniels-Test         Paul.Daniels-Test    db3prd0104mb103  9.668 GB (10,380,902,400 bytes)</p><p>Martin.Evans-Test         Martin.Evans-Test    db3prd0104mb104  9.668 GB (10,380,902,400 bytes)</p><p>DiscoverySearchMailbox... DiscoverySearchMa... db3prd0104mb118  50 GB (53,687,091,200 bytes)</p><p>SBE test account          sbe.test             db3prd0104mb120  9.668 GB (10,380,902,400 bytes)</p><p>Service Account           ServiceAccount       db3prd0104mb152  9.668 GB (10,380,902,400 bytes)</p><p>David.Elliott-Test        David.Elliott-Test   db3prd0104mb154  9.668 GB (10,380,902,400 bytes)</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>To Check if a someone is hidden from Address Book</u></strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>-----------------------------</p><p>False</p><p> </p><p> </p><p> </p><p><strong><u>Testing the Syntax for hiding and unhiding a Live @ EDU Mailbox</u></strong></p><p> </p><p> </p><p><u>Mailbox starts off hidden:</u></p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                  False</p><p><u>“HiddenFromAddressListsEnabled” doesn’t work:</u></p><p> </p><p>PS C:\Windows\system32&gt; set-mailbox -identity Andy.Bourne-Test -HiddenFromAddressListsEnabled $true</p><p>A positional parameter cannot be found that accepts argument '-HiddenFromAddressListsEnabled'.</p><p>    + CategoryInfo          : InvalidArgument: (:) [Set-Mailbox], ParameterBindingException</p><p>    + FullyQualifiedErrorId : PositionalParameterNotFound,Set-Mailbox</p><p> </p><p> </p><p> </p><p><u>“GalDisabledMailboxPlan” does work!!!!:</u></p><p> </p><p>PS C:\Windows\system32&gt; set-mailbox -identity Andy.Bourne-Test -MailboxPlan GalDisabledMailboxPlan</p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                   True</p><p> </p><p> </p><p>PS C:\Windows\system32&gt; set-mailbox -identity Andy.Bourne-Test -MailboxPlan DefaultMailboxPlan</p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p> </p><p> </p><p><strong><u>New Processes Required</u></strong></p><p> </p><p> </p><p><strong><u>AccManBackEndLibrary.Processes.StudentEmail</u></strong></p><p> </p><pre>·         <strong>HideInEmailAddressLists      handles transaction:  </strong>HIDE_IN_EMAIL_ADDRESS_LISTS = 122</pre><p><strong>     </strong></p><ul><li><strong>UnhideInEmailAddressLists    handles transaction:  </strong>UNHIDE_IN_EMAIL_ADDRESS_LISTS = 124</li></ul><p> </p><p><strong><u> </u></strong></p><p>HideInLiveEDUAddressLists(acc, ctx, adRow);</p><p><strong><u> </u></strong></p><p>UnhideInLiveEDUAddressLists(acc, ctx, adRow);</p><p> </p><p> </p><p>HideOutlookLiveEmailAddress</p><p> </p><p>UnhideOutlookLiveEmailAddress</p><p> </p><p> </p><p>Set-Mailbox -Identity Andy.Bourne-Test -HiddenFromAddressListsEnabled $true</p><p> </p><p> </p><p><strong>Exchange:</strong></p><p> </p><p>Set-Mailbox -Identity DOMAIN\$name -HiddenFromAddressListsEnabled $true</p><p> </p><p> </p><p><strong>Live@Edu - To Hide</strong></p><p> </p><p>Set-Mailbox &lt;Identity&gt; -MailboxPlan GalDisabledMailboxPlan</p><p> </p><p><strong>Live@Edu - To Unhide</strong></p><p> </p><p>Set-Mailbox &lt;Identity&gt; -MailboxPlan DefaultMailboxPlan</p><p> </p><p> </p><p> </p><p> </p><p align="center"><strong><u>Hiding &amp; Unhiding Alumni Email Addresses in the Outlook Global Address List</u></strong></p><p> </p><p> </p><p><strong><u>Run PowerShell as Administrator</u></strong></p><p> </p><p><strong>Set-ExecutionPolicy RemoteSigned</strong></p><p><strong> </strong></p><p><strong>$secpasswd = ConvertTo-SecureString '</strong> <strong>P4ssw0rd' -AsPlainText -Force;</strong></p><p> </p><p><strong>$Credentials = New-Object System.Management.Automation.PSCredential ('tad1.test\svc-tst-accman', $secpasswd);</strong></p><p> </p><p>Don’t think I need this . . . .</p><p> </p><p>$Credentials = Get-Credential</p><p> </p><p>Use “Basic” authentication for Test and Kerberos for Prod:</p><p> </p><p>$Script:Session = New-PSSession –ConfigurationName Microsoft.Exchange –ConnectionUri <strong>'</strong><a href="https://uos-t-exch-01.tad1.test/PowerShell/?SerializationLevel=Full" class="external-link" rel="nofollow">https://uos-t-exch-01.tad1.test/PowerShell/?SerializationLevel=Full</a><strong>'</strong> -Credential $Credentials –Authentication Basic</p><p> </p><p>Import-PSSession $Session</p><p> </p><p>Get-Mailbox . . . . . etc . . .</p><p> </p><p> </p><p>Remove-PSSession $Session</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><h2 id="DevelopmentNotes-HidingContactsfromGlobalAddressListusingExchangePowershell">Hiding Contacts from Global Address List using Exchange Powershell</h2><p> </p><p> </p><p><strong><u>Run PowerShell as Administrator</u></strong></p><p> </p><p><strong>Set-ExecutionPolicy RemoteSigned</strong></p><p> </p><p><strong>$Secpasswd = ConvertTo-SecureString 'P4ssw0rd' -AsPlainText -Force;</strong></p><p> </p><p><strong>$Credentials = New-Object System.Management.Automation.PSCredential (tad1.test\svc-tst-accman', $Secpasswd);</strong></p><p> </p><p>NB: Proxy is not required for Exchange (but is for Live@EDU).  If a proxy has been set in a previous session for Live@EDU then it will need to be cleared by using:</p><p> </p><p><strong>netsh</strong></p><p><strong> </strong></p><p><strong>netsh&gt; winhttp</strong></p><p><strong> </strong></p><p><strong>netsh winhttp&gt;reset proxy</strong></p><p><strong> </strong></p><p>Current WinHTTP proxy settings:</p><p> </p><p>    Direct access (no proxy server).</p><p><strong> </strong></p><p><strong>netsh winhttp&gt;show proxy</strong></p><p><strong> </strong></p><p>Current WinHTTP proxy settings:</p><p> </p><p>    Direct access (no proxy server).</p><p><strong> </strong></p><p><strong>netsh winhttp&gt;exit</strong></p><p> </p><p><strong>$sessionoptions = New-PSSessionOption -SkipCACheck</strong></p><p> </p><p><strong>$Script:Session = New-PSSession -ConfigurationName '<a href="http://schemas.microsoft.com/powershell/Microsoft.Exchange" class="external-link" rel="nofollow">http://schemas.microsoft.com/powershell/Microsoft.Exchange</a>' -ConnectionUri '<a href="https://uos-t-exch-01.tad1.test/PowerShell" class="external-link" rel="nofollow">https://uos-t-exch-01.tad1.test/PowerShell</a>' -Credential $Credentials -Authentication Basic -SessionOption $sessionoptions</strong></p><p> </p><p><strong>Import-PSSession $Session</strong></p><p> </p><p>You can then . . . .    <strong>Get-Mailbox –Identity &lt;identity&gt;   .</strong> . . . etc.</p><p> </p><p><strong>Remove-PSSession $Session</strong></p><p> </p><p> </p><p> </p><p><strong><u>Users in the Test Exchange 2010 System</u></strong></p><p> </p><p>Name                      Alias                ServerName       ProhibitSendQuota</p><p>----                      -----                ----------       -----------------</p><p>Enstein franky F          aaa0260              uos-t-exch-02    unlimited</p><p>lastname0823b firstnam... aaa0269              uos-t-exch-02    unlimited</p><p>Westy Testina T           aaa0270              uos-t-exch-02    unlimited</p><p>lastname0823c firstnam... aaa0271              uos-t-exch-02    unlimited</p><p>lastname0823d firstnam... aaa0272              uos-t-exch-02    unlimited</p><p>Bloggs Betty B            aaa04003             uos-t-exch-02    unlimited</p><p>Test2 Janus J             aaa04013             uos-t-exch-02    unlimited</p><p>Test3 Janus J             aaa04017             uos-t-exch-02    unlimited</p><p>Jordan Michael M aaa04033 AAA04033             uos-t-exch-01    unlimited</p><p>smith Tomkinson T         AAA04034             uos-t-exch-01    unlimited</p><p>Jones Tomkinson T aaa0... AAA04035             uos-t-exch-01    unlimited</p><p>Black Alan A aaa04048     AAA04048             uos-t-exch-01    unlimited</p><p>Black Charlie C aaa04050  AAA04050             uos-t-exch-01    unlimited</p><p>Black Emma E aaa04052     AAA04052             uos-t-exch-01    unlimited</p><p>Black Harry H aaa04055    AAA04055             uos-t-exch-01    unlimited</p><p>Black Mike M aaa04060     AAA04060             uos-t-exch-01    unlimited</p><p>Black Osim O aaa04062     AAA04062             uos-t-exch-01    unlimited</p><p>Keyhoe Mark M             aaa580               uos-t-exch-02    unlimited</p><p>Fish Claire C             aaa582               uos-t-exch-02    unlimited</p><p>Administrator             Administrator        uos-t-exch-02    unlimited</p><p>TestyTestyWooWoo2 ads220  ADS220               uos-t-exch-01    unlimited</p><p>ImaTestUser ads225        ADS225               uos-t-exch-01    unlimited</p><p>RGFuncTest6               ans226               uos-t-exch-02    unlimited</p><p>RGFuncTest7               ans227               uos-t-exch-02    unlimited</p><p>RGFuncTest8               ans228               uos-t-exch-02    unlimited</p><p>cTestyWestyL cTestyWes... ans238               uos-t-exch-02    unlimited</p><p>TestyWestyL TestyWesty... ans240               uos-t-exch-02    unlimited</p><p>MJPregenRN MJPregenFN A   ans241               uos-t-exch-02    unlimited</p><p>MJPregenRN2 MJPregenFN2 A ans242               uos-t-exch-02    unlimited</p><p>MJPregenRN3 MJPregenFN3 A ans243               uos-t-exch-02    unlimited</p><p>MJPregenRN4 MJPregenFN4 A ans244               uos-t-exch-02    unlimited</p><p>Testing1                  ass308               uos-t-exch-02    unlimited</p><p>QQQ Q QQ                  cbx006               uos-t-exch-02    unlimited</p><p>Gump4 A A                 cbx033               uos-t-exch-02    unlimited</p><p>DiscoverySearchMailbox... DiscoverySearchMa... uos-t-exch-01    50 GB (53,687,091,200 bytes)</p><p>RGFuncTest11              qss015               uos-t-exch-02    unlimited</p><p>RGFuncTest12              qss016               uos-t-exch-02    unlimited</p><p>RGFuncTest13              qss017               uos-t-exch-02    unlimited</p><p>RGFuncTest14              qss018               uos-t-exch-02    unlimited</p><p>RGFuncTest15              qss019               uos-t-exch-02    unlimited</p><p>RGFuncTest16              qss020               uos-t-exch-02    unlimited</p><p>RGFuncTest17              qss021               uos-t-exch-02    unlimited</p><p>RGFuncTest18              qss022               uos-t-exch-02    unlimited</p><p>RGX-User1Name             RGX-User1Alias       uos-t-exch-01    unlimited</p><p>RGX-User2Name             RGX-User2Alias       uos-t-exch-01    unlimited</p><p>svc-tst-accman            svc-tst-accman       uos-t-exch-02    unlimited</p><p>UIS673                    UIS673               uos-t-exch-02    unlimited</p><p>RGTesting104 xys004       XYS004               uos-t-exch-01    unlimited</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>Testing the hiding student “contacts” in Exchange Server . . . .</u></strong></p><p> </p><p>Only staff have a mail box in Exchange – students are stored as “MailContact”.  At present there is only one mailcontact on the test server (Identity = JamieFinlayson).  This student can be tested using PowerShell to see whether they are hidden or not. . . . . .</p><p> </p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact</p><p> </p><p>Name                      Alias                                          RecipientType</p><p>----                      -----                                          -------------</p><p>Jamie Finlayson           JamieFinlayson                                 MailContact</p><p> </p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson</p><p> </p><p>Name                      Alias                                          RecipientType</p><p>----                      -----                                          -------------</p><p>Jamie Finlayson           JamieFinlayson                                 MailContact</p><p> </p><p> </p><p>PS C:\Windows\system32&gt; set-mailcontact -identity JamieFinlayson -HiddenFromAddressListsEnabled $true</p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson | select hidden*</p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>-------------------------</p><p>True</p><p> </p><p>PS C:\Windows\system32&gt; set-mailcontact -identity JamieFinlayson –HiddenFromAddressListsEnabled $false</p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson | select hidden*</p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>-------------------------</p><p>False</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>Testing the Application</u></strong></p><p> </p><p> </p><p><strong><u>Initial State</u></strong></p><p> </p><p><strong>Result on Exchange </strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                  False</p><p> </p><p> </p><p> </p><p><strong>Result on Live@EDU</strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                  False</p><p> </p><p> </p><p> </p><p><strong><u>Testing on transaction type 122 (Hide email addresses)</u></strong></p><p> </p><p><strong>Result on Exchange </strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                   True</p><p> </p><p> </p><p> </p><p> </p><p><strong>Result on Live@EDU</strong></p><p> </p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                   True</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p><strong><u>Testing on transaction type 124 (Unhide email addresses)</u></strong></p><p> </p><p><strong>Result on Exchange </strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailcontact -identity JamieFinlayson | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                  False</p><p> </p><p> </p><p> </p><p><strong>Result on Live@EDU</strong></p><p> </p><p>PS C:\Windows\system32&gt; get-mailbox -identity Andy.Bourne-Test | select hidden*</p><p> </p><p>                                                                                          HiddenFromAddressListsEnabled</p><p>                                                                                          -----------------------------</p><p>                                                                                                                  False</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Mar 29, 2021 10:56</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
