<!DOCTYPE html>
<html>
    <head>
        <title>Accman : Modification to Fix Janus Multiple Valid Card Problem</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Accman</a></span>
                            </li>
                                                    <li>
                                <span><a href="Accman-Home_16384043.html">Accman Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_16384018.html">Documentation</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Accman : Modification to Fix Janus Multiple Valid Card Problem
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Julia Kelbrick</span>, last modified on Oct 25, 2013
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p> </p><h1 id="ModificationtoFixJanusMultipleValidCardProblem-OverviewoftheJanusMultipleValidCardProblem">Overview of the Janus Multiple Valid Card Problem</h1><p>The Janus ID Card System is provisioned by AccMan by populating two &quot;staging&quot; tables (actually a table and a view):</p><ul><li><strong>UoS_DataImport</strong> is a view which is used to provision brand new users who do not already exist in the Janus system.</li><li><strong>UoS_UserUpdate</strong> is a table which is used to update the details of users who do already exist in the Janus system.  Importantly, in the context of this issue, this table is used to change the validity status of the user's ID card.</li></ul><p>Whenever new records are created in either of these tables, &quot;black box&quot; processes in Janus uses the data supplied to create or update a user's details and card status in the system.</p><p>Whilst the process for the creation of new users is working satisfactorily, there are serious problems with the updating of card statuses which have resulted in user's having multiple valid cards.</p><p>The aim of this modification is to provide the<strong> UoS_UserUpdate</strong> table with more specific user details to enable the Janus update process to more accurately control the statuses of user's ID cards.</p><p> </p><h1 id="ModificationtoFixJanusMultipleValidCardProblem-CurrentJanusInterfaceinAccMan">Current Janus Interface in AccMan</h1><p>The process in AccMan that deals with provisioning of Janus is triggered by a type 97 transaction (UPDATE_JANUS_USER_DETAILS) for a given user. </p><p>The AccMan process first determines what the card status should be for the user based on the user's account status in AccMan.  If the user has an account status of &quot;VALID / PRESENT&quot; and their end date has not been reached then their ID card status should be &quot;Valid&quot;.  If on the otherhand they have an account status of &quot;DISABLED / LEFT&quot; or their end date has passed then their ID card status will currently be set to &quot;Suspended&quot;.</p><p>The AccMan process next looks in a view in the Janus database name &quot;<strong>OldCard</strong>&quot; to determine whether or not the user is new to the Janus system or whether they already exist.</p><p>If the user is new to the system then AccMan will create a record in a Janus view named &quot;<strong>UoS_DataImport</strong>&quot;, otherwise AccMan will create a record in a Janus table named &quot;<strong>UoS_UserUpdate</strong>&quot;.</p><p>Processes in the Janus software subsequently poll this &quot;staging&quot; table and &quot;staging&quot; view for new user records and updates the core Janus system data accordingly.</p><h1 style="margin-left: 30.0px;" id="ModificationtoFixJanusMultipleValidCardProblem-"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="500" confluence-query-params="effects=drop-shadow" src="attachments/16384072/16580609.jpg?effects=drop-shadow" data-image-src="attachments/16384072/16580609.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16580609" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Current Janus Interface in AccMan.jpg" data-base-url="https://confluence.salford.ac.uk:8444/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="16384072" data-linked-resource-container-version="25"></span></h1><p>The following table shows the mapping between the variables in AccMan and the columns in the UoS_UserUpdate table and crucially it can be seen that the user's existing card number is not being populated, which presumably accounts for the poor accuracy with which the Janus software processes are controlling the validity of the user's cards.</p><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-thumbnail" width="300" confluence-query-params="effects=drop-shadow" src="attachments/16384072/16580612.jpg?effects=drop-shadow" data-image-src="attachments/16384072/16580612.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16580612" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Table1.jpg" data-base-url="https://confluence.salford.ac.uk:8444/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="16384072" data-linked-resource-container-version="25"></span></p><p> </p><h2 id="ModificationtoFixJanusMultipleValidCardProblem-ProposedJanusInterfaceinAccMan">Proposed Janus Interface in AccMan</h2><p>The purpose of the proposed modification is two-fold.  Firstly to stop the situation in the future whereby users can end up having multiple valid cards and secondly to provide a way of logging those existing users who have more than one valid card so that their card status can be normalised manually.</p><p>The modification will introduce a new card status code of &quot;<strong>DeactivatedByExternalInterface</strong>&quot; which will be for sole used by AccMan.  AccMan currently sets the status to &quot;Suspended&quot; when it means to disable a card, which is the same status set by Janus itself.  The new status code will make it possible to identify that AccMan was responsible for making the change in card status.</p><p>Next, AccMan will be limited to modifying card records in Janus only if we can identify that the user has one &quot;Valid&quot; card or one &quot;DeactivatedByExternalInterface&quot; card:</p><p> </p><ol><li><span style="color: rgb(0,0,0);">If AccMan has determined that the user's card should be suspended, then if:</span></li></ol><ul><li style="list-style-type: none;background-image: none;"><ul><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 1 valid card</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 ‘DeactivatedByExternalInterface’ cards</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 or more cards with various other statuses – e.g. Lost, Damaged, Deactivated, Suspended, etc</span></span></li></ul></li></ul><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">   Make the one valid card status ‘DeactivatedByExternalInterface’</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">   NB: If the user already has 1 card with status 'DeactivatedByExternalInterface' and they have 0 cards of status 'Valid', then there is no need to do anything.</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);"><br/></span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">2.  If AccMan has determined that the user's card should be made valid, then if:</span></p><ul><li style="list-style-type: none;background-image: none;"><ul><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 valid cards</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 1 ‘DeactivatedByExternalInterface’ card</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 or more cards with various other statuses – e.g. Lost, Damaged, Deactivated, Suspended, etc</span></span></li></ul></li></ul><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">    Change status of the 1 ‘DeactivatedByExternalInterface’ card to ‘Valid’</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);"> </span><span style="color: rgb(0,0,0);"> </span><span style="color: rgb(0,0,0);">   NB: If the user already has 1 card with status 'Valid' and they have 0 cards of status '<span style="color: rgb(0,0,0);">DeactivatedByExternalInterface</span>', then there is no need to do anything.</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);"><br/></span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">3. In the following case AccMan - instead of raising an error - <strong>should do nothing</strong>:<br/></span></p><ul><li style="list-style-type: none;background-image: none;"><ul><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 valid cards</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 0 ‘DeactivatedByExternalInterface’ card</span></span></li><li><span style="color: rgb(0,0,0);"><span style="font-size: 7.0pt;font-family: &quot;Times New Roman&quot; , serif;"> </span><span>user has 1 or more cards with various other statuses – e.g. Lost, Damaged, Deactivated, Suspended, etc</span></span></li></ul></li></ul><p><span style="color: rgb(0,0,0);"><br/></span></p><p style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">4.   If a user is not in one of the states described above (e.g. if a user has 2 ‘Valid’ cards or a ‘Valid’ card and a ‘DeactivatedByExternalInterface’ card, or  two ‘DeactivatedByExternalInterface’ cards) then the interface should not change the card status – it should raise an error instead so that the user/card state can be normalized manually.</span></p><p style="margin-left: 60.0px;"><span style="color: rgb(0,0,0);"> </span><span class="confluence-embedded-file-wrapper image-left-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-left" width="500" confluence-query-params="effects=drop-shadow" src="attachments/16384072/16580610.jpg?effects=drop-shadow" data-image-src="attachments/16384072/16580610.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16580610" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Proposed Janus Interface in AccMan (1).jpg" data-base-url="https://confluence.salford.ac.uk:8444/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="16384072" data-linked-resource-container-version="25"></span></p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"> </p><p style="margin-left: 60.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="500" confluence-query-params="effects=drop-shadow" src="attachments/16384072/16581176.jpg?effects=drop-shadow" data-image-src="attachments/16384072/16581176.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16581176" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Proposed Janus User Maintenance Process In AccMan.jpg" data-base-url="https://confluence.salford.ac.uk:8444/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="16384072" data-linked-resource-container-version="25"></span></p><h3 id="ModificationtoFixJanusMultipleValidCardProblem-SQLtoretrievethenumberofcardswithstatusof&quot;Valid&quot;or&quot;DeactivatedByExternalInterface&quot;foragivenuser:">SQL to retrieve the number of cards with status of &quot;Valid&quot; or &quot;DeactivatedByExternalInterface&quot; for a given user:</h3><p> </p><pre><strong>SELECT COUNT(st.TokenData) <br/>FROM janus_users u<br/>LEFT JOIN janus_Departments d <br/>ON u.departmentId = d.departmentId<br/>LEFT JOIN janus_user_SecurityToken ust<br/>ON u.Userid = ust.UserId<br/>LEFT JOIN janus_securityTokens st <br/>ON ust.SecurityTokenId = st.SecurityTokenId<br/>LEFT JOIN janus_tokenTypes tt<br/>ON st.TokenTypeId = tt.TokenTypeId<br/>LEFT JOIN janus_tokenStatus ts<br/>ON st.TokenStatusId = ts.TokenStatusId<br/>WHERE ts.description = [Card Status: 'Valid' / 'DeactivatedByExternalInterface']<br/>AND u.EmpNumber = [AccMan rollnumber];</strong></pre><p> </p><h3 id="ModificationtoFixJanusMultipleValidCardProblem-SQLtoretrievetheCardID(s)ofcardswithstatusof&quot;Valid&quot;or&quot;DeactivatedByExternalInterface&quot;foragivenuser:"><strong>SQL to retrieve the Card ID(s) of cards with status of &quot;Valid&quot; or &quot;DeactivatedByExternalInterface&quot; for a given user:</strong></h3><p> </p><pre><strong>SELECT st.TokenData<br/>FROM janus_users u<br/>LEFT JOIN janus_Departments d <br/>ON u.departmentId = d.departmentId<br/>LEFT JOIN janus_user_SecurityToken ust<br/>ON u.Userid = ust.UserId<br/>LEFT JOIN janus_securityTokens st <br/>ON ust.SecurityTokenId = st.SecurityTokenId<br/>LEFT JOIN janus_tokenTypes tt<br/>ON st.TokenTypeId = tt.TokenTypeId<br/>LEFT JOIN janus_tokenStatus ts<br/>ON st.TokenStatusId = ts.TokenStatusId<br/>WHERE ts.description = [Card Status: 'Valid' / 'DeactivatedByExternalInterface']<br/>AND u.EmpNumber = [AccMan rollnumber];</strong></pre><p> </p><p> </p><p><strong><span style="color: rgb(0,51,102);">AccMan Application Files Modified:</span></strong></p><pre>Salford.AccMan.BackEnd.Processes.Janus.ProcessTransaction()</pre><pre>uk.ac.salford.accman.Models.MSSQL.JanusDAO.cs</pre><p><strong><span style="color: rgb(0,51,102);">AccMan Application Files Added:</span></strong></p><pre>uk.ac.salford.accman.Models.Enumerations.DBOperationType </pre><pre>uk.ac.salford.accman.Models.Enumerations.JanusCardStatus</pre><pre><br/><br/></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580609.jpg">Current Janus Interface in AccMan.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580610.jpg">Proposed Janus Interface in AccMan (1).jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580614.jpg">Proposed Janus Interface in AccMan (2).jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580613.jpg">Table1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580612.jpg">Table1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580615.jpg">Proposed Janus Interface in AccMan (2).jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580616.jpg">Proposed Janus Interface in AccMan (2).jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16580611.jpg">Proposed Janus Interface in AccMan (2).jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/16384072/16581176.jpg">Proposed Janus User Maintenance Process In AccMan.jpg</a> (image/jpeg)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Mar 29, 2021 10:56</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
